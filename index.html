<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet Lens</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230E0F12'/><circle cx='50' cy='50' r='30' fill='none' stroke='%23B8A45A' stroke-width='6'/><circle cx='50' cy='50' r='12' fill='%23B8A45A'/><line x1='72' y1='72' x2='90' y2='90' stroke='%23B8A45A' stroke-width='8' stroke-linecap='round'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0E0F12;
            --bg-card: #1C1F24;
            --bg-card-hover: #252830;
            --bg-input: #15171C;
            --gold: #B8A45A;
            --gold-dim: rgba(184, 164, 90, 0.15);
            --gold-bright: #D4C36A;
            --text: #F4F4F2;
            --text-dim: #A9ADB5;
            --text-muted: #6B7280;
            --border: #2D3139;
            --success: #34D399;
            --warning: #FBBF24;
            --danger: #F87171;
            --info: #60A5FA;
            --eth-color: #627EEA;
            --btc-color: #F7931A;
            --stable-color: #26A17B;
            --sidebar-width: 300px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--gold);
        }

        .logo-sub {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            letter-spacing: 0.05em;
        }

        .logo-sub a {
            color: var(--gold);
            text-decoration: none;
        }

        .logo-sub a:hover { text-decoration: underline; }

        /* Add Wallets Section */
        .add-section {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .section-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .input-wrapper {
            position: relative;
        }

        .address-input {
            width: 100%;
            height: 60px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', monospace;
            font-size: 10px;
            padding: 10px;
            padding-right: 40px;
            resize: none;
            transition: border-color 0.15s;
            overflow: hidden;
        }

        .address-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .address-input::placeholder {
            color: var(--text-muted);
        }

        .btn-paste {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-paste:hover {
            background: var(--gold);
            color: var(--bg);
            border-color: var(--gold);
        }

        .btn-add {
            width: 100%;
            height: 36px;
            margin-top: 10px;
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-add:hover { background: var(--gold-bright); }

        /* Library Section */
        .library-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 14px 0;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 8px;
        }

        .library-title {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .library-title span {
            color: var(--gold);
            font-weight: 500;
        }

        .library-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
            cursor: pointer;
        }

        .btn-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Roboto Condensed', sans-serif;
            padding: 4px;
            letter-spacing: 0.05em;
        }

        .btn-clear:hover { color: var(--danger); }

        .wallet-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
        }

        .wallet-list::-webkit-scrollbar { width: 4px; }
        .wallet-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .wallet-list::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .wallet-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 6px;
            transition: all 0.15s;
        }

        .wallet-item:hover {
            border-color: var(--gold-dim);
        }

        .wallet-item.unselected {
            opacity: 0.5;
        }

        .wallet-item-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .wallet-checkbox {
            width: 16px;
            height: 16px;
            appearance: none;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .wallet-checkbox:checked {
            background: var(--gold);
            border-color: var(--gold);
        }

        .wallet-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bg);
            font-size: 10px;
            font-weight: bold;
        }

        .chain-badge {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .chain-badge.eth {
            background: rgba(98, 126, 234, 0.15);
            color: var(--eth-color);
        }

        .chain-badge.btc {
            background: rgba(247, 147, 26, 0.15);
            color: var(--btc-color);
        }

        .wallet-info {
            flex: 1;
            min-width: 0;
        }

        .wallet-label-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 0;
            outline: none;
        }

        .wallet-label-input:hover {
            border-bottom-color: var(--border);
        }

        .wallet-label-input:focus {
            border-bottom-color: var(--gold);
        }

        .wallet-label-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
            font-weight: 400;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            letter-spacing: 0.02em;
        }

        .wallet-item-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
        }

        .wallet-stats {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-balance {
            font-size: 11px;
            font-weight: 500;
            color: var(--text);
        }

        .wallet-balance-usd {
            font-size: 9px;
            color: var(--text-muted);
        }

        .wallet-tokens {
            font-size: 9px;
            color: var(--text-dim);
        }

        .wallet-actions {
            display: flex;
            gap: 6px;
        }

        .wallet-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            padding: 2px;
            transition: color 0.15s;
        }

        .wallet-action:hover { color: var(--gold); }
        .wallet-action.delete:hover { color: var(--danger); }

        .wallet-list-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
        }

        .wallet-list-empty-icon {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .wallet-list-empty-text {
            font-size: 11px;
            line-height: 1.6;
        }

        /* Status Section */
        .status-section {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .status-item:last-child { margin-bottom: 0; }

        .status-label { color: var(--text-muted); font-weight: 400; }
        .status-value { color: var(--text-dim); font-weight: 500; }
        .status-value.success { color: var(--success); }
        .status-value.warning { color: var(--warning); }
        .status-value.eth { color: var(--eth-color); }
        .status-value.btc { color: var(--btc-color); }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 16px;
        }

        .segment-tabs {
            display: flex;
            gap: 0;
        }

        .segment-tab {
            padding: 0 20px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-right: none;
            color: var(--text-dim);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment-tab:last-child { border-right: 1px solid var(--border); }

        .segment-tab:hover {
            color: var(--text);
            border-color: var(--gold);
        }

        .segment-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg);
        }

        .segment-tab.active + .segment-tab {
            border-left-color: var(--gold);
        }

        .segment-tab .count {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .segment-tab.active .count {
            background: rgba(0,0,0,0.2);
            color: var(--bg);
        }

        .top-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 14px;
            height: 36px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-btn:hover,
        .dropdown-btn.open {
            border-color: var(--gold);
        }

        .dropdown-btn .value {
            color: var(--gold);
            font-weight: 600;
        }

        .dropdown-btn .arrow {
            font-size: 8px;
            color: var(--text-muted);
            transition: transform 0.15s;
        }

        .dropdown-btn.open .arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: all 0.15s;
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 14px;
            background: none;
            border: none;
            text-align: left;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-input);
            color: var(--text);
        }

        .dropdown-item.active {
            background: var(--gold-dim);
            color: var(--gold);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-icon:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .btn-icon.spinning {
            animation: spin 1s linear infinite;
        }

        .btn-icon.needs-refresh {
            background: rgba(251, 191, 36, 0.15);
            border-color: var(--warning);
            color: var(--warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); } 
            50% { box-shadow: 0 0 0 6px rgba(251, 191, 36, 0); } 
        }

        .btn-icon.open {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 24px;
        }

        .settings-panel.open { display: block; }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .settings-column h4 {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .settings-column h4.gold { color: var(--gold); border-color: var(--gold-dim); }
        .settings-column h4.eth { color: var(--eth-color); border-color: rgba(98,126,234,0.3); }
        .settings-column h4.btc { color: var(--btc-color); border-color: rgba(247,147,26,0.3); }

        .settings-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .setting-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Roboto Condensed', sans-serif;
            white-space: nowrap;
        }

        .setting-chip:hover {
            border-color: var(--gold);
            color: var(--text);
        }

        .setting-chip.active {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        .chip-check {
            width: 12px;
            height: 12px;
            border: 1px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0;
        }

        .setting-chip.active .chip-check {
            background: var(--gold);
            color: var(--bg);
        }

        /* Dashboard Segments */
        .segment-content {
            display: none;
        }

        .segment-content.active {
            display: block;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
            transition: all 0.15s;
        }

        .kpi-card:hover {
            border-color: var(--gold);
        }

        .kpi-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-badge {
            font-size: 8px;
            padding: 2px 4px;
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 500;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 300;
            color: var(--text);
            margin-bottom: 4px;
        }

        .kpi-value.gold { color: var(--gold); }
        .kpi-value.eth { color: var(--eth-color); }
        .kpi-value.btc { color: var(--btc-color); }
        .kpi-value.stable { color: var(--stable-color); }
        .kpi-value.success { color: var(--success); }
        .kpi-value.danger { color: var(--danger); }

        .kpi-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .kpi-sub.up { color: var(--success); }
        .kpi-sub.down { color: var(--danger); }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .chart-card.full { grid-column: span 2; }

        .chart-header {
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text);
        }

        .chart-subtitle {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-container {
            position: relative;
            height: 220px;
        }

        .chart-container.tall { height: 300px; }
        .chart-container.short { height: 160px; }

        /* Heatmap */
        .heatmap-wrapper {
            overflow-x: auto;
            padding: 8px 0;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(24, 1fr);
            gap: 2px;
            min-width: 550px;
        }

        .heatmap-label {
            font-size: 9px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--bg-input);
            border-radius: 2px;
            min-width: 14px;
        }

        .heatmap-cell.l1 { background: rgba(184, 164, 90, 0.2); }
        .heatmap-cell.l2 { background: rgba(184, 164, 90, 0.4); }
        .heatmap-cell.l3 { background: rgba(184, 164, 90, 0.6); }
        .heatmap-cell.l4 { background: rgba(184, 164, 90, 0.8); }
        .heatmap-cell.l5 { background: var(--gold); }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover { color: var(--gold); }

        th .sort-icon {
            margin-left: 4px;
            font-size: 8px;
            opacity: 0.4;
        }

        th.active .sort-icon { opacity: 1; color: var(--gold); }

        td {
            padding: 10px 12px;
            font-size: 12px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        tr:hover td { background: var(--bg-input); }

        .addr-cell {
            font-family: monospace;
            font-size: 11px;
        }

        .addr-cell a {
            color: var(--text);
            text-decoration: none;
        }

        .addr-cell a:hover { color: var(--gold); }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tag-whale { background: var(--gold-dim); color: var(--gold); }
        .tag-active { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .tag-dormant { background: rgba(107, 114, 128, 0.15); color: var(--text-muted); }
        .tag-trader { background: rgba(96, 165, 250, 0.15); color: var(--info); }
        .tag-hodler { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .tag-defi { background: rgba(167, 139, 250, 0.15); color: #A78BFA; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .empty-icon {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .empty-btn {
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 600;
            padding: 12px 28px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .empty-btn:hover { background: var(--gold-bright); }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(14, 15, 18, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .loading-progress {
            margin-top: 8px;
            font-size: 12px;
            color: var(--gold);
            font-family: monospace;
        }

        /* Data Warnings */
        .data-warnings {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 150;
            max-width: 380px;
        }

        .data-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--warning);
            border-left: 3px solid var(--warning);
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 11px;
            color: var(--text);
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .data-warning-title {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .data-warning-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
        }

        .data-warning-close:hover { color: var(--text); }

        /* Mobile Header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-brand {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--gold);
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        /* Mobile Add Wallet Bar - Always Visible */
        .mobile-add-bar {
            display: none;
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            z-index: 99;
        }

        .mobile-add-bar .input-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .mobile-add-bar .address-input-mobile {
            flex: 1;
            height: 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', monospace;
            font-size: 13px;
            padding: 0 12px;
            transition: border-color 0.15s;
        }

        .mobile-add-bar .address-input-mobile:focus {
            outline: none;
            border-color: var(--gold);
        }

        .mobile-add-bar .address-input-mobile::placeholder {
            color: var(--text-muted);
        }

        .mobile-add-bar .btn-paste-mobile {
            width: 44px;
            height: 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-add-bar .btn-paste-mobile:hover,
        .mobile-add-bar .btn-paste-mobile:active {
            background: var(--gold);
            color: var(--bg);
            border-color: var(--gold);
        }

        .mobile-add-bar .btn-add-mobile {
            height: 44px;
            padding: 0 16px;
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .mobile-add-bar .btn-add-mobile:hover,
        .mobile-add-bar .btn-add-mobile:active {
            background: var(--gold-bright);
        }

        .mobile-wallet-count {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .mobile-wallet-count .count-info {
            font-size: 11px;
            color: var(--text-muted);
        }

        .mobile-wallet-count .count-info span {
            color: var(--gold);
            font-weight: 600;
        }

        .mobile-wallet-count .btn-library {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 12px;
            font-size: 11px;
            font-family: 'Roboto Condensed', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mobile-wallet-count .btn-library:hover,
        .mobile-wallet-count .btn-library:active {
            border-color: var(--gold);
            color: var(--gold);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 45;
        }

        .sidebar-overlay.active { display: block; }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .settings-grid { grid-template-columns: 1fr; gap: 16px; }
        }

        @media (max-width: 900px) {
            .chart-grid { grid-template-columns: 1fr; }
            .chart-card.full { grid-column: span 1; }
        }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .mobile-add-bar { display: block; }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open { transform: translateX(0); }
            
            .main {
                margin-left: 0;
                padding: 16px;
                padding-top: 180px; /* Header 56px + Add bar ~124px */
            }

            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .segment-tabs {
                order: 1;
                justify-content: center;
            }

            .top-controls {
                order: 2;
                justify-content: center;
                flex-wrap: wrap;
            }

            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .kpi-card { padding: 14px; }
            .kpi-value { font-size: 20px; }
        }

        @media (max-width: 480px) {
            .segment-tab { padding: 0 12px; font-size: 11px; height: 32px; }
            .dropdown-btn { height: 32px; }
            .btn-icon { width: 32px; height: 32px; }
            .kpi-grid { gap: 8px; }
            .kpi-card { padding: 12px; }
            .kpi-label { font-size: 8px; }
            .kpi-value { font-size: 18px; }
            .kpi-sub { font-size: 10px; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing wallets...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <!-- Data Warnings -->
    <div class="data-warnings" id="dataWarnings"></div>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-brand">WALLET LENS</div>
        <button class="menu-btn" onclick="toggleSidebar()" title="Open Library">‚ò∞</button>
    </header>

    <!-- Mobile Add Wallet Bar -->
    <div class="mobile-add-bar" id="mobileAddBar">
        <div class="input-row">
            <input type="text" class="address-input-mobile" id="mobileAddressInput" 
                   placeholder="0x... / vitalik.eth / bc1q..." 
                   onkeypress="handleMobileEnter(event)">
            <button class="btn-paste-mobile" onclick="pasteFromClipboardMobile()" title="Paste">üìã</button>
            <button class="btn-add-mobile" onclick="addWalletsMobile()">+ Add</button>
        </div>
        <div class="mobile-wallet-count">
            <div class="count-info">
                <span id="mobileWalletCount">0</span> wallets tracked
            </div>
            <button class="btn-library" onclick="toggleSidebar()">üìö View Library</button>
        </div>
    </div>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-text">WALLET LENS</div>
                <div class="logo-sub">by <a href="https://twitter.com/beto_neh" target="_blank">@beto_neh</a></div>
            </div>

            <div class="add-section">
                <div class="section-label">Add Wallets</div>
                <div class="input-wrapper">
                    <textarea class="address-input" id="addressInput" placeholder="Paste addresses here&#10;0x... / vitalik.eth&#10;bc1q... / 3...&#10;Auto-detects chain"></textarea>
                    <button class="btn-paste" onclick="pasteFromClipboard()" title="Paste">üìã</button>
                </div>
                <button class="btn-add" onclick="addWallets()">+ Add to Library</button>
            </div>

            <div class="library-section">
                <div class="library-header">
                    <div class="library-title">LIBRARY <span id="libraryCount">(0)</span></div>
                    <div class="library-controls">
                        <select class="filter-select" id="libraryFilter" onchange="renderWalletList()">
                            <option value="all">All</option>
                            <option value="eth">ETH Only</option>
                            <option value="btc">BTC Only</option>
                            <option value="selected">Selected</option>
                        </select>
                        <button class="btn-clear" onclick="clearAllWallets()">Clear</button>
                    </div>
                </div>
                <div class="wallet-list" id="walletList">
                    <div class="wallet-list-empty">
                        <div class="wallet-list-empty-icon">üìã</div>
                        <div class="wallet-list-empty-text">No wallets yet.<br>Add addresses above to start.</div>
                    </div>
                </div>
            </div>

            <div class="status-section">
                <div class="status-item">
                    <span class="status-label">API Status</span>
                    <span class="status-value success" id="apiStatus">Ready</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ETH Price</span>
                    <span class="status-value eth" id="ethPriceDisplay">‚Äî</span>
                </div>
                <div class="status-item">
                    <span class="status-label">BTC Price</span>
                    <span class="status-value btc" id="btcPriceDisplay">‚Äî</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update</span>
                    <span class="status-value" id="lastUpdate">‚Äî</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="top-bar">
                <div class="segment-tabs">
                    <button class="segment-tab active" data-segment="combined" onclick="setSegment('combined')">
                        Combined <span class="count" id="countCombined">0</span>
                    </button>
                    <button class="segment-tab" data-segment="eth" onclick="setSegment('eth')">
                        Ethereum <span class="count" id="countEth">0</span>
                    </button>
                    <button class="segment-tab" data-segment="btc" onclick="setSegment('btc')">
                        Bitcoin <span class="count" id="countBtc">0</span>
                    </button>
                </div>

                <div class="top-controls">
                    <div class="dropdown" id="periodDropdown">
                        <button class="dropdown-btn" onclick="togglePeriodDropdown()">
                            <span class="value" id="periodValue">All</span>
                            <span class="arrow">‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="periodMenu">
                            <button class="dropdown-item" data-period="7" onclick="setPeriod(7)">7 Days</button>
                            <button class="dropdown-item" data-period="30" onclick="setPeriod(30)">30 Days</button>
                            <button class="dropdown-item" data-period="90" onclick="setPeriod(90)">90 Days</button>
                            <button class="dropdown-item" data-period="365" onclick="setPeriod(365)">1 Year</button>
                            <button class="dropdown-item active" data-period="0" onclick="setPeriod(0)">All Time</button>
                        </div>
                    </div>
                    <button class="btn-icon" id="refreshBtn" onclick="runAnalysis()" title="Refresh Analysis">‚Üª</button>
                    <button class="btn-icon" id="settingsBtn" onclick="toggleSettings()" title="Settings">‚öô</button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel">
                <div class="settings-grid">
                    <div class="settings-column">
                        <h4 class="gold">Combined (USD)</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="combined-kpis" onclick="toggleStat('combined-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="combined-allocation" onclick="toggleStat('combined-allocation')">
                                <span class="chip-check">‚úì</span> Portfolio Allocation
                            </button>
                            <button class="setting-chip active" data-stat="combined-flow" onclick="toggleStat('combined-flow')">
                                <span class="chip-check">‚úì</span> Capital Flow
                            </button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h4 class="eth">Ethereum</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="eth-kpis" onclick="toggleStat('eth-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="eth-aum" onclick="toggleStat('eth-aum')">
                                <span class="chip-check">‚úì</span> AUM Chart
                            </button>
                            <button class="setting-chip active" data-stat="eth-distribution" onclick="toggleStat('eth-distribution')">
                                <span class="chip-check">‚úì</span> Balance Distribution
                            </button>
                            <button class="setting-chip active" data-stat="eth-flow" onclick="toggleStat('eth-flow')">
                                <span class="chip-check">‚úì</span> Net Flow
                            </button>
                            <button class="setting-chip active" data-stat="eth-tokens" onclick="toggleStat('eth-tokens')">
                                <span class="chip-check">‚úì</span> Top Tokens
                            </button>
                            <button class="setting-chip active" data-stat="eth-segments" onclick="toggleStat('eth-segments')">
                                <span class="chip-check">‚úì</span> Segmentation
                            </button>
                            <button class="setting-chip active" data-stat="eth-heatmap" onclick="toggleStat('eth-heatmap')">
                                <span class="chip-check">‚úì</span> Activity Heatmap
                            </button>
                            <button class="setting-chip active" data-stat="eth-lorenz" onclick="toggleStat('eth-lorenz')">
                                <span class="chip-check">‚úì</span> Lorenz Curve
                            </button>
                            <button class="setting-chip active" data-stat="eth-tables" onclick="toggleStat('eth-tables')">
                                <span class="chip-check">‚úì</span> Tables
                            </button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h4 class="btc">Bitcoin</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="btc-kpis" onclick="toggleStat('btc-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="btc-distribution" onclick="toggleStat('btc-distribution')">
                                <span class="chip-check">‚úì</span> Balance Distribution
                            </button>
                            <button class="setting-chip active" data-stat="btc-flow" onclick="toggleStat('btc-flow')">
                                <span class="chip-check">‚úì</span> Flow Chart
                            </button>
                            <button class="setting-chip active" data-stat="btc-table" onclick="toggleStat('btc-table')">
                                <span class="chip-check">‚úì</span> Wallet Table
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Segment -->
            <div class="segment-content active" id="segment-combined">
                <div id="combined-empty" class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-title">No Data Yet</div>
                    <div class="empty-text">Add wallets to your library and click Refresh to analyze.</div>
                </div>
                <div id="combined-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="combined-kpis-section">
                        <div class="kpi-grid" id="combinedKpis"></div>
                    </div>
                    <!-- Allocation Chart -->
                    <div id="combined-allocation-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Portfolio Allocation</div>
                                <div class="chart-subtitle">Distribution by asset type</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="allocationChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Value by Chain</div>
                                <div class="chart-subtitle">ETH vs BTC holdings</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chainChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Capital Flow -->
                    <div id="combined-flow-section" class="chart-grid">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">Combined Capital Flow</div>
                                <div class="chart-subtitle">Weekly inflows vs outflows (ETH only, timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container tall">
                                <canvas id="combinedFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ethereum Segment -->
            <div class="segment-content" id="segment-eth">
                <div id="eth-empty" class="empty-state">
                    <div class="empty-icon">Œû</div>
                    <div class="empty-title">No Ethereum Wallets</div>
                    <div class="empty-text">Add ETH addresses to see Ethereum analytics.</div>
                </div>
                <div id="eth-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="eth-kpis-section">
                        <div class="kpi-grid" id="ethKpis"></div>
                    </div>
                    <!-- AUM Chart -->
                    <div id="eth-aum-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">AUM Over Time</div>
                                <div class="chart-subtitle">Estimated historical balance (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container tall">
                                <canvas id="aumChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Distribution & Flow -->
                    <div id="eth-distribution-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Balance Distribution</div>
                                <div class="chart-subtitle">Wallets by ETH range</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="balanceDistChart"></canvas>
                            </div>
                        </div>
                        <div id="eth-flow-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Net Flow Analysis</div>
                                <div class="chart-subtitle">Weekly inflows vs outflows (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="netFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Tokens & Segments -->
                    <div id="eth-tokens-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Top 10 Tokens</div>
                                <div class="chart-subtitle">By USD value</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="topTokensChart"></canvas>
                            </div>
                        </div>
                        <div id="eth-segments-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">User Segmentation</div>
                                <div class="chart-subtitle">By behavior pattern (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="segmentChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Token List Table -->
                    <div id="eth-tokenlist-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All Token Holdings</div>
                                <div class="chart-subtitle">Complete token breakdown with USD values</div>
                            </div>
                            <div class="table-container">
                                <table id="allTokensTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Token</th>
                                            <th style="text-align: right;">Balance</th>
                                            <th style="text-align: right;">Price</th>
                                            <th style="text-align: right;">USD Value</th>
                                            <th style="text-align: right;">% of Tokens</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Heatmap & Lorenz -->
                    <div id="eth-heatmap-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Activity Heatmap</div>
                                <div class="chart-subtitle">Transaction frequency by day/hour (UTC, timeframe-adjusted)</div>
                            </div>
                            <div class="heatmap-wrapper">
                                <div class="heatmap-grid" id="heatmapGrid"></div>
                            </div>
                        </div>
                        <div id="eth-lorenz-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Capital Concentration</div>
                                <div class="chart-subtitle">Lorenz curve ¬∑ Gini: <span id="giniValue">‚Äî</span></div>
                            </div>
                            <div class="chart-container">
                                <canvas id="lorenzChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Tables -->
                    <div id="eth-tables-section" class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Top 10 Wallets</div>
                                <div class="chart-subtitle">By total USD value</div>
                            </div>
                            <div class="table-container">
                                <table id="topWalletsTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Address</th>
                                            <th>Value</th>
                                            <th>% AUM</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Segment Breakdown</div>
                                <div class="chart-subtitle">Wallets by behavior type</div>
                            </div>
                            <div class="table-container">
                                <table id="segmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Segment</th>
                                            <th>Count</th>
                                            <th>%</th>
                                            <th>Avg Value</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All ETH Wallets</div>
                                <div class="chart-subtitle">Complete breakdown</div>
                            </div>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table id="allEthTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th class="sortable" data-sort="address" onclick="sortEthTable('address')">Address <span class="sort-icon"></span></th>
                                            <th class="sortable active" data-sort="value" onclick="sortEthTable('value')">Value <span class="sort-icon">‚ñº</span></th>
                                            <th class="sortable" data-sort="tokens" onclick="sortEthTable('tokens')">Tokens <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="tx" onclick="sortEthTable('tx')">Tx <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="age" onclick="sortEthTable('age')">Age <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="last" onclick="sortEthTable('last')">Last Active <span class="sort-icon"></span></th>
                                            <th>Funding</th>
                                            <th>Segment</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bitcoin Segment -->
            <div class="segment-content" id="segment-btc">
                <div id="btc-empty" class="empty-state">
                    <div class="empty-icon">‚Çø</div>
                    <div class="empty-title">No Bitcoin Wallets</div>
                    <div class="empty-text">Add BTC addresses to see Bitcoin analytics.</div>
                </div>
                <div id="btc-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="btc-kpis-section">
                        <div class="kpi-grid" id="btcKpis"></div>
                    </div>
                    <!-- Distribution & Flow -->
                    <div id="btc-distribution-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Balance Distribution</div>
                                <div class="chart-subtitle">BTC by wallet</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="btcDistChart"></canvas>
                            </div>
                        </div>
                        <div id="btc-flow-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Flow Analysis</div>
                                <div class="chart-subtitle">Total received vs sent</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="btcFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Table -->
                    <div id="btc-table-section" class="chart-grid">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All BTC Wallets</div>
                                <div class="chart-subtitle">Complete breakdown</div>
                            </div>
                            <div class="table-container">
                                <table id="allBtcTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Address</th>
                                            <th>Balance</th>
                                            <th>USD Value</th>
                                            <th>Tx Count</th>
                                            <th>Total Received</th>
                                            <th>Total Sent</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    ETHERSCAN_API: 'https://api.etherscan.io/v2/api',
    CHAINID: '1',
    ETHERSCAN_KEY: 'Y73RUTA4VPZYAZH23U8H3KZ1A37Z3C5CJZ',
    BLOCKSTREAM_API: 'https://blockstream.info/api',
    COINGECKO_API: 'https://api.coingecko.com/api/v3/simple/price',
    COINGECKO_TOKEN_API: 'https://api.coingecko.com/api/v3/simple/token_price/ethereum',
    DELAY_MS: 250,
    TX_LIMIT: 1000,
    TOKEN_LIMIT: 100,
    STABLECOINS: ['usdt', 'usdc', 'dai', 'busd', 'tusd', 'usdp', 'frax', 'lusd', 'usdd', 'gusd'],
    // Map of common token symbols to CoinGecko IDs
    TOKEN_IDS: {
        'USDT': 'tether',
        'USDC': 'usd-coin',
        'DAI': 'dai',
        'WETH': 'weth',
        'WBTC': 'wrapped-bitcoin',
        'LINK': 'chainlink',
        'UNI': 'uniswap',
        'AAVE': 'aave',
        'MKR': 'maker',
        'SNX': 'havven',
        'COMP': 'compound-governance-token',
        'CRV': 'curve-dao-token',
        'LDO': 'lido-dao',
        'SHIB': 'shiba-inu',
        'PEPE': 'pepe',
        'APE': 'apecoin',
        'SAND': 'the-sandbox',
        'MANA': 'decentraland',
        'GRT': 'the-graph',
        'ENS': 'ethereum-name-service',
        'MATIC': 'matic-network',
        'STETH': 'staked-ether',
        'RETH': 'rocket-pool-eth',
        'CBETH': 'coinbase-wrapped-staked-eth',
        'FRAX': 'frax',
        'LUSD': 'liquity-usd',
        'BUSD': 'binance-usd',
        'TUSD': 'true-usd',
        'FXS': 'frax-share',
        'RPL': 'rocket-pool',
        '1INCH': '1inch',
        'SUSHI': 'sushi',
        'YFI': 'yearn-finance',
        'BAL': 'balancer',
        'DYDX': 'dydx',
        'IMX': 'immutable-x',
        'ARB': 'arbitrum',
        'OP': 'optimism',
        'BLUR': 'blur',
        'WLD': 'worldcoin-wld',
        'BONK': 'bonk'
    },
    DEFI_PROTOCOLS: {
        '0x7a250d5630b4cf539739df2c5dacb4c659f2488d': 'Uniswap V2',
        '0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45': 'Uniswap V3',
        '0xe592427a0aece92de3edee1f18e0157c05861564': 'Uniswap V3',
        '0xdef1c0ded9bec7f1a1670819833240f027b25eff': '0x Protocol',
        '0x1111111254fb6c44bac0bed2854e76f90643097d': '1inch',
        '0x881d40237659c251811cec9c364ef91dc08d300c': 'MetaMask',
        '0x7d2768de32b0b80b7a3454c06bdac94a69ddc7a9': 'Aave V2',
        '0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2': 'Aave V3',
        '0xae7ab96520de3a18e5e111b5eaab095312d7fe84': 'Lido',
    },
    WBTC_ADDRESS: '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599'
};

// ============================================
// STATE
// ============================================
let state = {
    wallets: [],
    ethData: [],
    btcData: [],
    ethPrice: 0,
    btcPrice: 0,
    tokenPrices: {}, // Cache for token prices { symbol: priceUsd }
    segment: 'combined',
    period: 0,
    visibleStats: {
        'combined-kpis': true,
        'combined-allocation': true,
        'combined-flow': true,
        'eth-kpis': true,
        'eth-aum': true,
        'eth-distribution': true,
        'eth-flow': true,
        'eth-tokens': true,
        'eth-tokenlist': true,
        'eth-segments': true,
        'eth-heatmap': true,
        'eth-lorenz': true,
        'eth-tables': true,
        'btc-kpis': true,
        'btc-distribution': true,
        'btc-flow': true,
        'btc-table': true
    },
    ethTableSort: { col: 'value', asc: false },
    charts: {},
    needsRefresh: false,
    warnings: []
};

// ============================================
// UTILITIES
// ============================================
const delay = ms => new Promise(r => setTimeout(r, ms));
const weiToEth = w => (!w || w === '0') ? 0 : parseFloat(w) / 1e18;
const satToBtc = s => (!s || s === 0) ? 0 : s / 1e8;
const shorten = (a, n = 6, m = 4) => a ? `${a.slice(0, n)}...${a.slice(-m)}` : '';

const fmt = (n, d = 4) => {
    if (n === undefined || n === null || isNaN(n)) return '0';
    if (n === 0) return '0';
    if (Math.abs(n) < 0.0001) return n < 0 ? '<-0.0001' : '<0.0001';
    if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(2) + 'K';
    return parseFloat(n.toFixed(d)).toLocaleString();
};

const fmtUsd = n => '$' + fmt(n, 2);
const fmtEth = n => fmt(n, 4) + ' ETH';
const fmtBtc = n => fmt(n, 6) + ' BTC';

const fmtAge = days => {
    if (days >= 365) {
        const y = Math.floor(days / 365);
        const m = Math.floor((days % 365) / 30);
        return y + 'y' + (m > 0 ? ' ' + m + 'm' : '');
    }
    if (days >= 30) {
        const m = Math.floor(days / 30);
        const d = Math.floor(days % 30);
        return m + 'm' + (d > 0 ? ' ' + d + 'd' : '');
    }
    return Math.floor(days) + 'd';
};

const isEthAddress = a => /^0x[a-fA-F0-9]{40}$/.test(a?.trim());
const isENS = a => /^[a-zA-Z0-9][a-zA-Z0-9-]*\.eth$/i.test(a?.trim());
const isBtcAddress = a => /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,62}$/.test(a?.trim());

const detectChain = addr => {
    if (isEthAddress(addr) || isENS(addr)) return 'eth';
    if (isBtcAddress(addr)) return 'btc';
    return null;
};

const calcGini = values => {
    const sorted = [...values].filter(v => v > 0).sort((a, b) => a - b);
    const n = sorted.length;
    if (n === 0) return 0;
    let sum = 0, cumSum = 0;
    sorted.forEach((v, i) => {
        cumSum += v;
        sum += (i + 1) * v;
    });
    return (2 * sum) / (n * cumSum) - (n + 1) / n;
};

// ============================================
// LOCAL STORAGE
// ============================================
function loadState() {
    try {
        const saved = localStorage.getItem('walletlens_v3');
        if (saved) {
            const data = JSON.parse(saved);
            state.wallets = data.wallets || [];
            state.visibleStats = { ...state.visibleStats, ...data.visibleStats };
            state.segment = data.segment || 'combined';
            state.period = data.period ?? 30;
        }
    } catch (e) {
        console.error('Error loading state:', e);
    }
}

function saveState() {
    try {
        localStorage.setItem('walletlens_v3', JSON.stringify({
            wallets: state.wallets,
            visibleStats: state.visibleStats,
            segment: state.segment,
            period: state.period
        }));
    } catch (e) {
        console.error('Error saving state:', e);
    }
}

// ============================================
// API CALLS
// ============================================
async function resolveENS(name) {
    try {
        const res = await fetch(`https://api.ensideas.com/ens/resolve/${name}`);
        const data = await res.json();
        return data.address || null;
    } catch {
        return null;
    }
}

async function fetchPrices() {
    try {
        const res = await fetch(`${CONFIG.COINGECKO_API}?ids=ethereum,bitcoin&vs_currencies=usd`);
        const data = await res.json();
        state.ethPrice = data.ethereum?.usd || 0;
        state.btcPrice = data.bitcoin?.usd || 0;
        document.getElementById('ethPriceDisplay').textContent = fmtUsd(state.ethPrice);
        document.getElementById('btcPriceDisplay').textContent = fmtUsd(state.btcPrice);
    } catch (e) {
        console.error('Error fetching prices:', e);
    }
}

// Fetch prices for multiple tokens from CoinGecko
async function fetchTokenPrices(symbols) {
    try {
        // Get CoinGecko IDs for known tokens
        const ids = symbols
            .map(s => CONFIG.TOKEN_IDS[s.toUpperCase()])
            .filter(id => id);
        
        if (ids.length === 0) return;
        
        const res = await fetch(`${CONFIG.COINGECKO_API}?ids=${ids.join(',')}&vs_currencies=usd`);
        const data = await res.json();
        
        // Map back to symbols
        Object.entries(CONFIG.TOKEN_IDS).forEach(([symbol, id]) => {
            if (data[id]?.usd) {
                state.tokenPrices[symbol.toUpperCase()] = data[id].usd;
            }
        });
        
        // Stablecoins default to $1
        CONFIG.STABLECOINS.forEach(s => {
            state.tokenPrices[s.toUpperCase()] = 1;
        });
        
    } catch (e) {
        console.error('Error fetching token prices:', e);
    }
}

// Get token price from cache or estimate
function getTokenPrice(symbol) {
    const sym = symbol.toUpperCase();
    if (state.tokenPrices[sym]) return state.tokenPrices[sym];
    if (CONFIG.STABLECOINS.includes(sym.toLowerCase())) return 1;
    return 0; // Unknown token
}

async function etherscanCall(module, action, params = {}) {
    const url = new URL(CONFIG.ETHERSCAN_API);
    url.searchParams.set('chainid', CONFIG.CHAINID);
    url.searchParams.set('module', module);
    url.searchParams.set('action', action);
    url.searchParams.set('apikey', CONFIG.ETHERSCAN_KEY);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    
    const res = await fetch(url);
    const data = await res.json();
    return data;
}

async function fetchEthWallet(address) {
    const result = {
        address,
        balance: 0,
        tokens: [],        // Token transactions (for flow analysis)
        tokenBalances: [], // Actual current balances
        rawTx: [],
        rawInternalTx: [],
        wbtcBalance: 0
    };

    // ETH Balance
    const balRes = await etherscanCall('account', 'balance', { address, tag: 'latest' });
    if (balRes.status === '1') {
        result.balance = weiToEth(balRes.result);
    }
    await delay(CONFIG.DELAY_MS);

    // Try to get actual token balances using addresstokenbalance
    const tokenBalRes = await etherscanCall('account', 'addresstokenbalance', { address, page: 1, offset: 100 });
    if (tokenBalRes.status === '1' && Array.isArray(tokenBalRes.result)) {
        result.tokenBalances = tokenBalRes.result.map(t => ({
            symbol: t.TokenSymbol || 'UNKNOWN',
            name: t.TokenName || '',
            balance: parseFloat(t.TokenQuantity) || 0,
            contractAddress: t.TokenAddress,
            decimals: parseInt(t.TokenDivisor) || 18
        })).filter(t => t.balance > 0);
        
        // Get WBTC balance from token balances
        const wbtc = result.tokenBalances.find(t => 
            t.contractAddress?.toLowerCase() === CONFIG.WBTC_ADDRESS
        );
        if (wbtc) {
            result.wbtcBalance = wbtc.balance;
        }
    }
    await delay(CONFIG.DELAY_MS);

    // Get token transactions (for flow analysis and fallback balances)
    const tokRes = await etherscanCall('account', 'tokentx', { address, page: 1, offset: CONFIG.TOKEN_LIMIT, sort: 'desc' });
    if (tokRes.status === '1' && Array.isArray(tokRes.result)) {
        if (tokRes.result.length >= CONFIG.TOKEN_LIMIT) {
            addWarning(`Token limit reached for ${shorten(address)}`, 'Some tokens may be missing.');
        }
        result.tokens = tokRes.result;
        
        // If addresstokenbalance failed, calculate from transactions
        if (result.tokenBalances.length === 0) {
            const tokenMap = new Map();
            tokRes.result.forEach(tx => {
                const sym = tx.tokenSymbol?.toUpperCase() || 'UNKNOWN';
                const dec = parseInt(tx.tokenDecimal) || 18;
                const val = parseFloat(tx.value) / Math.pow(10, dec);
                const key = `${sym}_${tx.contractAddress}`;
                
                if (!tokenMap.has(key)) {
                    tokenMap.set(key, {
                        symbol: sym,
                        name: tx.tokenName || '',
                        balance: 0,
                        contractAddress: tx.contractAddress,
                        decimals: dec
                    });
                }
                
                const token = tokenMap.get(key);
                if (tx.to?.toLowerCase() === address.toLowerCase()) {
                    token.balance += val;
                } else {
                    token.balance -= val;
                }
            });
            
            result.tokenBalances = [...tokenMap.values()]
                .filter(t => t.balance > 0.0001);
            
            // Calculate WBTC from transactions if not set
            if (result.wbtcBalance === 0) {
                const wbtc = result.tokenBalances.find(t => 
                    t.contractAddress?.toLowerCase() === CONFIG.WBTC_ADDRESS
                );
                if (wbtc) result.wbtcBalance = wbtc.balance;
            }
        }
    }
    await delay(CONFIG.DELAY_MS);

    // Normal Transactions
    const txRes = await etherscanCall('account', 'txlist', { address, page: 1, offset: CONFIG.TX_LIMIT, sort: 'desc' });
    if (txRes.status === '1' && Array.isArray(txRes.result)) {
        if (txRes.result.length >= CONFIG.TX_LIMIT) {
            addWarning(`Transaction limit reached for ${shorten(address)}`, 'Volume calculations may be incomplete.');
        }
        result.rawTx = txRes.result;
    }
    await delay(CONFIG.DELAY_MS);

    // Internal Transactions
    const intRes = await etherscanCall('account', 'txlistinternal', { address, page: 1, offset: CONFIG.TX_LIMIT, sort: 'desc' });
    if (intRes.status === '1' && Array.isArray(intRes.result)) {
        result.rawInternalTx = intRes.result;
    }
    await delay(CONFIG.DELAY_MS);

    return result;
}

async function fetchBtcWallet(address) {
    try {
        const res = await fetch(`${CONFIG.BLOCKSTREAM_API}/address/${address}`);
        const data = await res.json();
        
        const funded = data.chain_stats?.funded_txo_sum || 0;
        const spent = data.chain_stats?.spent_txo_sum || 0;
        
        return {
            address,
            balance: satToBtc(funded - spent),
            totalReceived: satToBtc(funded),
            totalSent: satToBtc(spent),
            txCount: (data.chain_stats?.tx_count || 0) + (data.mempool_stats?.tx_count || 0)
        };
    } catch (e) {
        console.error('BTC fetch error:', e);
        return { address, balance: 0, totalReceived: 0, totalSent: 0, txCount: 0 };
    }
}

// ============================================
// DATA ANALYSIS
// ============================================
function analyzeEthWallet(data, period) {
    const now = Date.now();
    const periodMs = period === 0 ? Infinity : period * 24 * 60 * 60 * 1000;
    const cutoff = period === 0 ? 0 : now - periodMs;

    const allTx = [...(data.rawTx || []), ...(data.rawInternalTx || [])];
    const periodTx = allTx.filter(tx => parseInt(tx.timeStamp) * 1000 >= cutoff);

    // Calculate metrics
    let totalVolume = 0, gasSpent = 0, inflow = 0, outflow = 0;
    const addr = data.address.toLowerCase();

    periodTx.forEach(tx => {
        const val = weiToEth(tx.value);
        totalVolume += val;
        
        if (tx.to?.toLowerCase() === addr) inflow += val;
        else if (tx.from?.toLowerCase() === addr) outflow += val;
        
        if (tx.gasUsed && tx.gasPrice) {
            gasSpent += weiToEth(BigInt(tx.gasUsed) * BigInt(tx.gasPrice));
        }
    });

    // Use actual token balances with prices
    const tokens = (data.tokenBalances || []).map(t => {
        const price = getTokenPrice(t.symbol);
        return {
            symbol: t.symbol,
            name: t.name || t.symbol,
            balance: t.balance,
            value: t.balance * price,
            price: price,
            contractAddress: t.contractAddress
        };
    }).filter(t => t.balance > 0.0001);
    
    // Sort by USD value descending
    tokens.sort((a, b) => b.value - a.value);
    
    // Calculate total token value
    const totalTokenValue = tokens.reduce((sum, t) => sum + t.value, 0);

    // Find first tx for funding source
    const sortedTx = [...(data.rawTx || [])].sort((a, b) => parseInt(a.timeStamp) - parseInt(b.timeStamp));
    let fundingSource = 'Unknown';
    if (sortedTx.length > 0) {
        const firstTx = sortedTx[0];
        if (firstTx.from) {
            const fromAddr = firstTx.from.toLowerCase();
            fundingSource = CONFIG.DEFI_PROTOCOLS[fromAddr] || shorten(firstTx.from);
        }
    }

    // Age calculation
    const firstTimestamp = sortedTx.length > 0 ? parseInt(sortedTx[0].timeStamp) * 1000 : now;
    const ageDays = (now - firstTimestamp) / (24 * 60 * 60 * 1000);

    // Last activity
    const lastTx = allTx.length > 0 ? 
        Math.max(...allTx.map(tx => parseInt(tx.timeStamp))) * 1000 : null;

    // Segmentation
    const isActive = periodTx.length > 0;
    const txFreq = periodTx.length / (period || 365);
    let segment = 'Inactive';
    
    if (isActive) {
        if (data.balance >= 100) segment = 'Whale';
        else if (txFreq > 1) segment = 'Trader';
        else if (txFreq > 0.1) segment = 'Active';
        else segment = 'Hodler';
    } else if (data.balance > 0) {
        segment = 'Dormant';
    }

    return {
        totalVolume,
        gasSpent,
        inflow,
        outflow,
        netFlow: inflow - outflow,
        txCount: periodTx.length,
        totalTxCount: allTx.length,
        tokens,
        tokCount: tokens.length,
        totalTokenValue,
        fundingSource,
        ageDays,
        lastAct: lastTx ? new Date(lastTx) : null,
        isActive,
        segment
    };
}

// ============================================
// UI FUNCTIONS
// ============================================
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('active');
}

function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const btn = document.getElementById('settingsBtn');
    panel.classList.toggle('open');
    btn.classList.toggle('open');
}

function toggleStat(stat) {
    state.visibleStats[stat] = !state.visibleStats[stat];
    document.querySelectorAll(`.setting-chip[data-stat="${stat}"]`).forEach(el => {
        el.classList.toggle('active', state.visibleStats[stat]);
    });
    updateStatVisibility();
    saveState();
}

function updateStatVisibility() {
    Object.entries(state.visibleStats).forEach(([stat, visible]) => {
        const section = document.getElementById(`${stat}-section`);
        const card = document.getElementById(`${stat}-card`);
        if (section) section.style.display = visible ? '' : 'none';
        if (card) card.style.display = visible ? '' : 'none';
    });
}

function setSegment(seg) {
    state.segment = seg;
    document.querySelectorAll('.segment-tab').forEach(el => {
        el.classList.toggle('active', el.dataset.segment === seg);
    });
    document.querySelectorAll('.segment-content').forEach(el => {
        el.classList.toggle('active', el.id === `segment-${seg}`);
    });
    saveState();
}

function togglePeriodDropdown() {
    const btn = document.querySelector('#periodDropdown .dropdown-btn');
    const menu = document.getElementById('periodMenu');
    btn.classList.toggle('open');
    menu.classList.toggle('open');
}

function closePeriodDropdown() {
    const btn = document.querySelector('#periodDropdown .dropdown-btn');
    const menu = document.getElementById('periodMenu');
    btn.classList.remove('open');
    menu.classList.remove('open');
}

function setPeriod(period) {
    state.period = period;
    
    // Update dropdown display
    const labels = { 7: '7D', 30: '30D', 90: '90D', 365: '1Y', 0: 'All' };
    document.getElementById('periodValue').textContent = labels[period] || '30D';
    
    // Update active state
    document.querySelectorAll('.dropdown-item[data-period]').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.period) === period);
    });
    
    closePeriodDropdown();
    saveState();
    
    // Re-analyze with new period if we have data
    if (state.ethData.length > 0) {
        state.ethData.forEach(w => {
            w.analyzed = analyzeEthWallet(w, period);
        });
        renderDashboard();
    }
}

function markNeedsRefresh() {
    state.needsRefresh = true;
    document.getElementById('refreshBtn').classList.add('needs-refresh');
}

function clearNeedsRefresh() {
    state.needsRefresh = false;
    document.getElementById('refreshBtn').classList.remove('needs-refresh');
}

function showLoading(text = 'Analyzing wallets...') {
    document.getElementById('loadingOverlay').classList.add('active');
    document.querySelector('.loading-text').textContent = text;
    document.getElementById('loadingProgress').textContent = '';
}

function updateLoading(progress) {
    document.getElementById('loadingProgress').textContent = progress;
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function addWarning(title, message) {
    const id = Date.now();
    state.warnings.push({ id, title, message });
    renderWarnings();
    setTimeout(() => dismissWarning(id), 10000);
}

function dismissWarning(id) {
    state.warnings = state.warnings.filter(w => w.id !== id);
    renderWarnings();
}

function renderWarnings() {
    const container = document.getElementById('dataWarnings');
    container.innerHTML = state.warnings.map(w => `
        <div class="data-warning">
            <button class="data-warning-close" onclick="dismissWarning(${w.id})">√ó</button>
            <div class="data-warning-title">‚ö†Ô∏è ${w.title}</div>
            <div>${w.message}</div>
        </div>
    `).join('');
}

async function pasteFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('addressInput').value = text;
    } catch (e) {
        console.error('Clipboard error:', e);
    }
}

// Mobile-specific functions
async function pasteFromClipboardMobile() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('mobileAddressInput').value = text;
    } catch (e) {
        console.error('Clipboard error:', e);
    }
}

function handleMobileEnter(event) {
    if (event.key === 'Enter') {
        addWalletsMobile();
    }
}

async function addWalletsMobile() {
    const input = document.getElementById('mobileAddressInput');
    const lines = input.value.split(/[\n,]/).map(l => l.trim()).filter(l => l);
    
    for (const line of lines) {
        let address = line;
        let chain = detectChain(line);
        
        // Resolve ENS
        if (isENS(line)) {
            showLoading('Resolving ENS...');
            const resolved = await resolveENS(line);
            if (resolved) {
                address = resolved;
                chain = 'eth';
            } else {
                addWarning('ENS Resolution Failed', `Could not resolve ${line}`);
                continue;
            }
            hideLoading();
        }
        
        if (!chain) {
            addWarning('Invalid Address', `"${shorten(line, 10, 6)}" is not a valid address.`);
            continue;
        }
        
        // Check for duplicates
        const exists = state.wallets.some(w => w.address.toLowerCase() === address.toLowerCase());
        if (exists) continue;
        
        state.wallets.push({
            address,
            chain,
            label: isENS(line) ? line : '',
            selected: true,
            addedAt: Date.now(),
            balance: null,
            tokenCount: null
        });
    }
    
    input.value = '';
    saveState();
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
    
    // Auto-refresh analysis when wallet is added
    if (state.wallets.length > 0) {
        await runAnalysis();
    }
}

function updateMobileWalletCount() {
    const countEl = document.getElementById('mobileWalletCount');
    if (countEl) {
        countEl.textContent = state.wallets.length;
    }
}

async function addWallets() {
    const input = document.getElementById('addressInput');
    const lines = input.value.split(/[\n,]/).map(l => l.trim()).filter(l => l);
    
    for (const line of lines) {
        let address = line;
        let chain = detectChain(line);
        
        // Resolve ENS
        if (isENS(line)) {
            showLoading('Resolving ENS...');
            const resolved = await resolveENS(line);
            if (resolved) {
                address = resolved;
                chain = 'eth';
            } else {
                addWarning('ENS Resolution Failed', `Could not resolve ${line}`);
                continue;
            }
            hideLoading();
        }
        
        if (!chain) {
            addWarning('Invalid Address', `"${shorten(line, 10, 6)}" is not a valid address.`);
            continue;
        }
        
        // Check for duplicates
        const exists = state.wallets.some(w => w.address.toLowerCase() === address.toLowerCase());
        if (exists) continue;
        
        state.wallets.push({
            address,
            chain,
            label: isENS(line) ? line : '',
            selected: true,
            addedAt: Date.now(),
            balance: null,
            tokenCount: null
        });
    }
    
    input.value = '';
    saveState();
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
    
    // Auto-refresh analysis when wallet is added
    if (state.wallets.length > 0) {
        await runAnalysis();
    }
}

function removeWallet(address) {
    state.wallets = state.wallets.filter(w => w.address !== address);
    saveState();
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
    markNeedsRefresh();
}

function toggleWalletSelection(address) {
    const wallet = state.wallets.find(w => w.address === address);
    if (wallet) {
        wallet.selected = !wallet.selected;
        saveState();
        renderWalletList();
        updateCounts();
        markNeedsRefresh();
    }
}

function updateWalletLabel(address, label) {
    const wallet = state.wallets.find(w => w.address === address);
    if (wallet) {
        wallet.label = label;
        saveState();
    }
}

function clearAllWallets() {
    if (confirm('Remove all wallets from library?')) {
        state.wallets = [];
        state.ethData = [];
        state.btcData = [];
        saveState();
        renderWalletList();
        updateCounts();
        updateMobileWalletCount();
        renderDashboard();
    }
}

function renderWalletList() {
    const container = document.getElementById('walletList');
    const filter = document.getElementById('libraryFilter').value;
    
    let wallets = state.wallets;
    if (filter === 'eth') wallets = wallets.filter(w => w.chain === 'eth');
    else if (filter === 'btc') wallets = wallets.filter(w => w.chain === 'btc');
    else if (filter === 'selected') wallets = wallets.filter(w => w.selected);
    
    if (wallets.length === 0) {
        container.innerHTML = `
            <div class="wallet-list-empty">
                <div class="wallet-list-empty-icon">üìã</div>
                <div class="wallet-list-empty-text">No wallets${filter !== 'all' ? ' matching filter' : ''}.<br>Add addresses above to start.</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = wallets.map(w => {
        const balanceDisplay = w.balance !== null ? 
            (w.chain === 'eth' ? fmtEth(w.balance) : fmtBtc(w.balance)) : '‚Äî';
        const usdDisplay = w.balance !== null ? 
            fmtUsd(w.balance * (w.chain === 'eth' ? state.ethPrice : state.btcPrice)) : '';
        const tokensDisplay = w.chain === 'eth' && w.tokenCount !== null ? 
            `${w.tokenCount} tokens` : '';
        const explorer = w.chain === 'eth' ? 
            `https://etherscan.io/address/${w.address}` : 
            `https://blockstream.info/address/${w.address}`;
        
        return `
            <div class="wallet-item ${w.selected ? '' : 'unselected'}">
                <div class="wallet-item-top">
                    <input type="checkbox" class="wallet-checkbox" 
                        ${w.selected ? 'checked' : ''} 
                        onchange="toggleWalletSelection('${w.address}')">
                    <div class="chain-badge ${w.chain}">${w.chain === 'eth' ? 'Œû' : '‚Çø'}</div>
                    <div class="wallet-info">
                        <input type="text" class="wallet-label-input" 
                            placeholder="Add label..." 
                            value="${w.label || ''}"
                            onchange="updateWalletLabel('${w.address}', this.value)">
                        <div class="wallet-address">${shorten(w.address)}</div>
                    </div>
                </div>
                <div class="wallet-item-bottom">
                    <div class="wallet-stats">
                        <div class="wallet-balance">${balanceDisplay}</div>
                        ${usdDisplay ? `<div class="wallet-balance-usd">${usdDisplay}</div>` : ''}
                        ${tokensDisplay ? `<div class="wallet-tokens">${tokensDisplay}</div>` : ''}
                    </div>
                    <div class="wallet-actions">
                        <a href="${explorer}" target="_blank" class="wallet-action" title="View on Explorer">üîó</a>
                        <button class="wallet-action delete" onclick="removeWallet('${w.address}')" title="Remove">üóë</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('libraryCount').textContent = `(${state.wallets.length})`;
}

function updateCounts() {
    const selected = state.wallets.filter(w => w.selected);
    const ethCount = selected.filter(w => w.chain === 'eth').length;
    const btcCount = selected.filter(w => w.chain === 'btc').length;
    
    document.getElementById('countCombined').textContent = selected.length;
    document.getElementById('countEth').textContent = ethCount;
    document.getElementById('countBtc').textContent = btcCount;
}

// ============================================
// MAIN ANALYSIS
// ============================================
async function runAnalysis() {
    const selected = state.wallets.filter(w => w.selected);
    if (selected.length === 0) {
        addWarning('No Wallets Selected', 'Select at least one wallet to analyze.');
        return;
    }
    
    showLoading('Fetching prices...');
    await fetchPrices();
    
    const ethWallets = selected.filter(w => w.chain === 'eth');
    const btcWallets = selected.filter(w => w.chain === 'btc');
    
    state.ethData = [];
    state.btcData = [];
    
    // Fetch ETH wallets
    for (let i = 0; i < ethWallets.length; i++) {
        const w = ethWallets[i];
        updateLoading(`ETH ${i + 1}/${ethWallets.length}: ${shorten(w.address)}`);
        
        try {
            const data = await fetchEthWallet(w.address);
            data.label = w.label;
            data.analyzed = analyzeEthWallet(data, state.period);
            state.ethData.push(data);
            
            // Update wallet in library
            const libWallet = state.wallets.find(lw => lw.address === w.address);
            if (libWallet) {
                libWallet.balance = data.balance;
                libWallet.tokenCount = data.analyzed.tokCount;
            }
        } catch (e) {
            console.error('ETH fetch error:', e);
            addWarning('Fetch Error', `Failed to fetch ${shorten(w.address)}`);
        }
    }
    
    // Fetch BTC wallets
    for (let i = 0; i < btcWallets.length; i++) {
        const w = btcWallets[i];
        updateLoading(`BTC ${i + 1}/${btcWallets.length}: ${shorten(w.address)}`);
        
        try {
            const data = await fetchBtcWallet(w.address);
            data.label = w.label;
            state.btcData.push(data);
            
            // Update wallet in library
            const libWallet = state.wallets.find(lw => lw.address === w.address);
            if (libWallet) {
                libWallet.balance = data.balance;
            }
        } catch (e) {
            console.error('BTC fetch error:', e);
        }
        
        await delay(100);
    }
    
    // Fetch token prices for all unique tokens
    if (state.ethData.length > 0) {
        updateLoading('Fetching token prices...');
        const allSymbols = new Set();
        state.ethData.forEach(w => {
            (w.tokenBalances || []).forEach(t => {
                allSymbols.add(t.symbol.toUpperCase());
            });
        });
        await fetchTokenPrices([...allSymbols]);
        
        // Re-analyze with prices
        state.ethData.forEach(w => {
            w.analyzed = analyzeEthWallet(w, state.period);
        });
    }
    
    hideLoading();
    clearNeedsRefresh();
    saveState();
    renderWalletList();
    renderDashboard();
    
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

// ============================================
// DASHBOARD RENDERING
// ============================================
function renderDashboard() {
    renderCombinedDashboard();
    renderEthDashboard();
    renderBtcDashboard();
    updateStatVisibility();
}

function renderCombinedDashboard() {
    const hasData = state.ethData.length > 0 || state.btcData.length > 0;
    document.getElementById('combined-empty').style.display = hasData ? 'none' : '';
    document.getElementById('combined-content').style.display = hasData ? '' : 'none';
    
    if (!hasData) return;
    
    // Calculate totals
    const ethTotal = state.ethData.reduce((s, w) => s + w.balance, 0);
    const btcTotal = state.btcData.reduce((s, w) => s + w.balance, 0);
    const wbtcTotal = state.ethData.reduce((s, w) => s + (w.wbtcBalance || 0), 0);
    
    const ethUsd = ethTotal * state.ethPrice;
    const btcUsd = btcTotal * state.btcPrice;
    const wbtcUsd = wbtcTotal * state.btcPrice;
    
    // Stablecoin calculation - use value which already has USD
    let stableUsd = 0;
    let otherTokensUsd = 0;
    state.ethData.forEach(w => {
        (w.analyzed?.tokens || []).forEach(t => {
            if (CONFIG.STABLECOINS.includes(t.symbol.toLowerCase())) {
                stableUsd += t.value || t.balance; // value has USD, fallback to balance for stables
            } else {
                otherTokensUsd += t.value || 0;
            }
        });
    });
    
    const totalUsd = ethUsd + btcUsd + wbtcUsd + stableUsd + otherTokensUsd;
    
    // Net flow (ETH only since BTC API doesn't give timestamps)
    const netFlowEth = state.ethData.reduce((s, w) => s + (w.analyzed?.netFlow || 0), 0);
    const netFlowUsd = netFlowEth * state.ethPrice;
    
    // Total transactions
    const totalTx = state.ethData.reduce((s, w) => s + (w.analyzed?.txCount || 0), 0) +
                    state.btcData.reduce((s, w) => s + w.txCount, 0);
    
    // KPIs
    document.getElementById('combinedKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total AUM</div>
            <div class="kpi-value gold">${fmtUsd(totalUsd)}</div>
            <div class="kpi-sub">${state.ethData.length + state.btcData.length} wallets</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">ETH Value</div>
            <div class="kpi-value eth">${fmtUsd(ethUsd)}</div>
            <div class="kpi-sub">${fmtEth(ethTotal)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">BTC Value</div>
            <div class="kpi-value btc">${fmtUsd(btcUsd)}</div>
            <div class="kpi-sub">${fmtBtc(btcTotal)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Stablecoins</div>
            <div class="kpi-value stable">${fmtUsd(stableUsd)}</div>
            <div class="kpi-sub">${((stableUsd / totalUsd) * 100).toFixed(1)}% of AUM</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">WBTC Held <span class="kpi-badge">ETH</span></div>
            <div class="kpi-value btc">${fmtUsd(wbtcUsd)}</div>
            <div class="kpi-sub">${fmt(wbtcTotal, 6)} WBTC</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net Flow <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value ${netFlowUsd >= 0 ? 'success' : 'danger'}">${netFlowUsd >= 0 ? '+' : ''}${fmtUsd(netFlowUsd)}</div>
            <div class="kpi-sub">${netFlowEth >= 0 ? '+' : ''}${fmtEth(netFlowEth)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transactions <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">All chains</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Wallets <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value">${state.ethData.filter(w => w.analyzed?.isActive).length}</div>
            <div class="kpi-sub">of ${state.ethData.length} ETH wallets</div>
        </div>
    `;
    
    // Allocation Chart - now includes other tokens properly
    renderAllocationChart(ethUsd, btcUsd + wbtcUsd, stableUsd, otherTokensUsd);
    
    // Chain Chart
    renderChainChart(ethUsd, btcUsd);
    
    // Combined Flow Chart
    renderCombinedFlowChart();
}

function renderEthDashboard() {
    const hasData = state.ethData.length > 0;
    document.getElementById('eth-empty').style.display = hasData ? 'none' : '';
    document.getElementById('eth-content').style.display = hasData ? '' : 'none';
    
    if (!hasData) return;
    
    // Calculate metrics
    const totalEth = state.ethData.reduce((s, w) => s + w.balance, 0);
    const ethUsd = totalEth * state.ethPrice;
    const totalTokens = new Set();
    let stableUsd = 0;
    let totalTokenValue = 0;
    
    state.ethData.forEach(w => {
        (w.analyzed?.tokens || []).forEach(t => {
            totalTokens.add(t.symbol);
            totalTokenValue += t.value || 0;
            if (CONFIG.STABLECOINS.includes(t.symbol.toLowerCase())) {
                stableUsd += t.value || t.balance;
            }
        });
    });
    
    const totalAum = ethUsd + totalTokenValue;
    const netFlow = state.ethData.reduce((s, w) => s + (w.analyzed?.netFlow || 0), 0);
    const totalTx = state.ethData.reduce((s, w) => s + (w.analyzed?.txCount || 0), 0);
    const totalGas = state.ethData.reduce((s, w) => s + (w.analyzed?.gasSpent || 0), 0);
    const activeCount = state.ethData.filter(w => w.analyzed?.isActive).length;
    const wbtcTotal = state.ethData.reduce((s, w) => s + (w.wbtcBalance || 0), 0);
    
    // KPIs
    document.getElementById('ethKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total ETH</div>
            <div class="kpi-value eth">${fmtEth(totalEth)}</div>
            <div class="kpi-sub">${fmtUsd(ethUsd)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Token Holdings</div>
            <div class="kpi-value gold">${fmtUsd(totalTokenValue)}</div>
            <div class="kpi-sub">${totalTokens.size} unique tokens</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Stablecoin Exposure</div>
            <div class="kpi-value stable">${fmtUsd(stableUsd)}</div>
            <div class="kpi-sub">${totalAum > 0 ? ((stableUsd / totalAum) * 100).toFixed(1) : 0}% of AUM</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">WBTC Balance</div>
            <div class="kpi-value btc">${fmt(wbtcTotal, 6)}</div>
            <div class="kpi-sub">${fmtUsd(wbtcTotal * state.btcPrice)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net Flow <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value ${netFlow >= 0 ? 'success' : 'danger'}">${netFlow >= 0 ? '+' : ''}${fmtEth(netFlow)}</div>
            <div class="kpi-sub">${fmtUsd(netFlow * state.ethPrice)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Wallets <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value">${activeCount}</div>
            <div class="kpi-sub">${((activeCount / state.ethData.length) * 100).toFixed(0)}% of total</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transactions <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">Normal + Internal</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Gas Spent <span class="kpi-badge">${state.period || 'ALL'}D</span></div>
            <div class="kpi-value">${fmtEth(totalGas)}</div>
            <div class="kpi-sub">${fmtUsd(totalGas * state.ethPrice)}</div>
        </div>
    `;
    
    // Render charts
    renderAumChart();
    renderBalanceDistChart();
    renderNetFlowChart();
    renderTopTokensChart();
    renderTokenListTable();
    renderSegmentChart();
    renderHeatmap();
    renderLorenzChart();
    renderEthTables();
}

function renderBtcDashboard() {
    const hasData = state.btcData.length > 0;
    document.getElementById('btc-empty').style.display = hasData ? 'none' : '';
    document.getElementById('btc-content').style.display = hasData ? '' : 'none';
    
    if (!hasData) return;
    
    const totalBtc = state.btcData.reduce((s, w) => s + w.balance, 0);
    const totalReceived = state.btcData.reduce((s, w) => s + w.totalReceived, 0);
    const totalSent = state.btcData.reduce((s, w) => s + w.totalSent, 0);
    const totalTx = state.btcData.reduce((s, w) => s + w.txCount, 0);
    
    // KPIs
    document.getElementById('btcKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total BTC</div>
            <div class="kpi-value btc">${fmtBtc(totalBtc)}</div>
            <div class="kpi-sub">${fmtUsd(totalBtc * state.btcPrice)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Received</div>
            <div class="kpi-value success">${fmtBtc(totalReceived)}</div>
            <div class="kpi-sub">${fmtUsd(totalReceived * state.btcPrice)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Sent</div>
            <div class="kpi-value danger">${fmtBtc(totalSent)}</div>
            <div class="kpi-sub">${fmtUsd(totalSent * state.btcPrice)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transaction Count</div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">All time</div>
        </div>
    `;
    
    // Charts
    renderBtcDistChart();
    renderBtcFlowChart();
    renderBtcTable();
}

// ============================================
// CHART RENDERING
// ============================================
const chartColors = {
    gold: '#B8A45A',
    goldDim: 'rgba(184, 164, 90, 0.2)',
    eth: '#627EEA',
    ethDim: 'rgba(98, 126, 234, 0.2)',
    btc: '#F7931A',
    btcDim: 'rgba(247, 147, 26, 0.2)',
    success: '#34D399',
    successDim: 'rgba(52, 211, 153, 0.4)',
    danger: '#F87171',
    dangerDim: 'rgba(248, 113, 113, 0.4)',
    stable: '#26A17B',
    stableDim: 'rgba(38, 161, 123, 0.2)',
    muted: '#6B7280'
};

const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { display: false }
    },
    scales: {
        x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#A9ADB5', font: { size: 10 } }
        },
        y: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#A9ADB5', font: { size: 10 } }
        }
    }
};

function renderAllocationChart(eth, btc, stable, other) {
    const ctx = document.getElementById('allocationChart');
    if (state.charts.allocation) state.charts.allocation.destroy();
    
    const data = [
        { label: 'ETH', value: eth, color: chartColors.eth },
        { label: 'BTC', value: btc, color: chartColors.btc },
        { label: 'Stables', value: stable, color: chartColors.stable },
        { label: 'Other', value: Math.max(0, other), color: chartColors.muted }
    ].filter(d => d.value > 0);
    
    state.charts.allocation = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.label),
            datasets: [{
                data: data.map(d => d.value),
                backgroundColor: data.map(d => d.color),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: '#A9ADB5', font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.label}: ${fmtUsd(ctx.raw)}`
                    }
                }
            }
        }
    });
}

function renderChainChart(eth, btc) {
    const ctx = document.getElementById('chainChart');
    if (state.charts.chain) state.charts.chain.destroy();
    
    state.charts.chain = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Ethereum', 'Bitcoin'],
            datasets: [{
                data: [eth, btc],
                backgroundColor: [chartColors.ethDim, chartColors.btcDim],
                borderColor: [chartColors.eth, chartColors.btc],
                borderWidth: 2
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { label: ctx => fmtUsd(ctx.raw) }
                }
            }
        }
    });
}

function renderCombinedFlowChart() {
    const ctx = document.getElementById('combinedFlowChart');
    if (state.charts.combinedFlow) state.charts.combinedFlow.destroy();
    
    const data = generateFlowSeries();
    
    state.charts.combinedFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Inflow',
                    data: data.inflow,
                    backgroundColor: chartColors.successDim,
                    borderColor: chartColors.success,
                    borderWidth: 1
                },
                {
                    label: 'Outflow',
                    data: data.outflow.map(v => -v),
                    backgroundColor: chartColors.dangerDim,
                    borderColor: chartColors.danger,
                    borderWidth: 1
                }
            ]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#A9ADB5', font: { size: 10 } }
                }
            },
            scales: {
                ...chartDefaults.scales,
                x: { ...chartDefaults.scales.x, stacked: true },
                y: { 
                    ...chartDefaults.scales.y, 
                    stacked: true,
                    ticks: {
                        ...chartDefaults.scales.y.ticks,
                        callback: v => fmtEth(Math.abs(v))
                    }
                }
            }
        }
    });
}

function renderAumChart() {
    const ctx = document.getElementById('aumChart');
    if (state.charts.aum) state.charts.aum.destroy();
    
    const data = generateAumSeries();
    
    state.charts.aum = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                borderColor: chartColors.gold,
                backgroundColor: chartColors.goldDim,
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { label: ctx => fmtEth(ctx.raw) }
                }
            },
            scales: {
                ...chartDefaults.scales,
                y: {
                    ...chartDefaults.scales.y,
                    ticks: {
                        ...chartDefaults.scales.y.ticks,
                        callback: v => fmtEth(v)
                    }
                }
            }
        }
    });
}

function renderBalanceDistChart() {
    const ctx = document.getElementById('balanceDistChart');
    if (state.charts.balDist) state.charts.balDist.destroy();
    
    const balances = state.ethData.map(w => w.balance).filter(b => b > 0);
    const buckets = [0.01, 0.1, 1, 10, 100, 1000, 10000];
    const labels = ['<0.01', '0.01-0.1', '0.1-1', '1-10', '10-100', '100-1K', '1K-10K', '>10K'];
    
    const dist = buckets.map((b, i) => {
        const min = i === 0 ? 0 : buckets[i - 1];
        return balances.filter(bal => bal >= min && bal < b).length;
    });
    dist.push(balances.filter(b => b >= 10000).length);
    
    state.charts.balDist = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                data: dist,
                backgroundColor: chartColors.goldDim,
                borderColor: chartColors.gold,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { label: ctx => `${ctx.raw} wallets` }
                }
            }
        }
    });
}

function renderNetFlowChart() {
    const ctx = document.getElementById('netFlowChart');
    if (state.charts.netFlow) state.charts.netFlow.destroy();
    
    const data = generateFlowSeries();
    
    state.charts.netFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Inflow',
                    data: data.inflow,
                    backgroundColor: chartColors.successDim,
                    borderColor: chartColors.success,
                    borderWidth: 1
                },
                {
                    label: 'Outflow',
                    data: data.outflow.map(v => -v),
                    backgroundColor: chartColors.dangerDim,
                    borderColor: chartColors.danger,
                    borderWidth: 1
                }
            ]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#A9ADB5', font: { size: 9 } }
                }
            },
            scales: {
                ...chartDefaults.scales,
                x: { ...chartDefaults.scales.x, stacked: true },
                y: { ...chartDefaults.scales.y, stacked: true }
            }
        }
    });
}

function renderTopTokensChart() {
    const ctx = document.getElementById('topTokensChart');
    if (state.charts.tokens) state.charts.tokens.destroy();
    
    // Aggregate tokens across all wallets with USD values
    const tokenMap = new Map();
    state.ethData.forEach(w => {
        (w.analyzed?.tokens || []).forEach(t => {
            const current = tokenMap.get(t.symbol) || { balance: 0, value: 0 };
            tokenMap.set(t.symbol, {
                balance: current.balance + t.balance,
                value: current.value + t.value
            });
        });
    });
    
    // Sort by USD value and take top 10
    const sorted = [...tokenMap.entries()]
        .sort((a, b) => b[1].value - a[1].value)
        .slice(0, 10);
    
    state.charts.tokens = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(s => s[0]),
            datasets: [{
                data: sorted.map(s => s[1].value),
                backgroundColor: chartColors.goldDim,
                borderColor: chartColors.gold,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { 
                        label: ctx => {
                            const token = sorted[ctx.dataIndex];
                            return `${fmtUsd(token[1].value)} (${fmt(token[1].balance, 4)} ${token[0]})`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        callback: value => fmtUsd(value),
                        color: '#A9ADB5',
                        font: { size: 10 }
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                },
                y: {
                    ticks: { color: '#A9ADB5', font: { size: 10 } },
                    grid: { display: false }
                }
            }
        }
    });
}

function renderTokenListTable() {
    const tbody = document.querySelector('#allTokensTable tbody');
    if (!tbody) return;
    
    // Aggregate all tokens across wallets
    const tokenMap = new Map();
    state.ethData.forEach(w => {
        (w.analyzed?.tokens || []).forEach(t => {
            const key = t.symbol;
            const current = tokenMap.get(key) || { 
                symbol: t.symbol, 
                name: t.name,
                balance: 0, 
                value: 0, 
                price: t.price 
            };
            tokenMap.set(key, {
                ...current,
                balance: current.balance + t.balance,
                value: current.value + t.value
            });
        });
    });
    
    // Sort by USD value
    const tokens = [...tokenMap.values()].sort((a, b) => b.value - a.value);
    
    // Calculate total for percentage
    const totalValue = tokens.reduce((sum, t) => sum + t.value, 0);
    
    if (tokens.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 24px;">
                    No tokens found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = tokens.map((t, i) => `
        <tr>
            <td>${i + 1}</td>
            <td>
                <div style="font-weight: 500;">${t.symbol}</div>
                ${t.name && t.name !== t.symbol ? `<div style="font-size: 10px; color: var(--text-muted);">${t.name}</div>` : ''}
            </td>
            <td style="text-align: right; font-family: monospace;">${fmt(t.balance, t.balance < 1 ? 6 : 2)}</td>
            <td style="text-align: right; color: var(--text-muted);">${t.price > 0 ? fmtUsd(t.price) : '‚Äî'}</td>
            <td style="text-align: right; font-weight: 500; color: ${t.value > 0 ? 'var(--gold)' : 'var(--text-muted)'};">${t.value > 0 ? fmtUsd(t.value) : '‚Äî'}</td>
            <td style="text-align: right; color: var(--text-muted);">${totalValue > 0 ? ((t.value / totalValue) * 100).toFixed(1) + '%' : '‚Äî'}</td>
        </tr>
    `).join('');
}

function renderSegmentChart() {
    const ctx = document.getElementById('segmentChart');
    if (state.charts.segment) state.charts.segment.destroy();
    
    const segments = {};
    state.ethData.forEach(w => {
        const seg = w.analyzed?.segment || 'Unknown';
        segments[seg] = (segments[seg] || 0) + 1;
    });
    
    const data = Object.entries(segments).filter(e => e[1] > 0);
    const colors = ['#B8A45A', '#34D399', '#60A5FA', '#F59E0B', '#A78BFA', '#EC4899', '#6B7280'];
    
    state.charts.segment = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d[0]),
            datasets: [{
                data: data.map(d => d[1]),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: '#A9ADB5', font: { size: 10 } }
                }
            }
        }
    });
}

function renderHeatmap() {
    const container = document.getElementById('heatmapGrid');
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const heat = Array(7).fill(null).map(() => Array(24).fill(0));
    
    const now = Date.now();
    const periodMs = state.period === 0 ? Infinity : state.period * 24 * 60 * 60 * 1000;
    const cutoff = state.period === 0 ? 0 : now - periodMs;
    
    state.ethData.forEach(w => {
        [...(w.rawTx || []), ...(w.rawInternalTx || [])].forEach(tx => {
            const ts = parseInt(tx.timeStamp) * 1000;
            if (ts >= cutoff) {
                const d = new Date(ts);
                heat[d.getUTCDay()][d.getUTCHours()]++;
            }
        });
    });
    
    const max = Math.max(...heat.flat()) || 1;
    const level = v => {
        if (v === 0) return '';
        const p = v / max;
        if (p <= 0.2) return 'l1';
        if (p <= 0.4) return 'l2';
        if (p <= 0.6) return 'l3';
        if (p <= 0.8) return 'l4';
        return 'l5';
    };
    
    let html = '<div class="heatmap-label"></div>';
    for (let h = 0; h < 24; h++) {
        html += `<div class="heatmap-label">${h}</div>`;
    }
    
    days.forEach((day, di) => {
        html += `<div class="heatmap-label">${day}</div>`;
        for (let h = 0; h < 24; h++) {
            const v = heat[di][h];
            html += `<div class="heatmap-cell ${level(v)}" title="${day} ${h}:00 - ${v} tx"></div>`;
        }
    });
    
    container.innerHTML = html;
}

function renderLorenzChart() {
    const ctx = document.getElementById('lorenzChart');
    if (state.charts.lorenz) state.charts.lorenz.destroy();
    
    const balances = state.ethData.map(w => w.balance).filter(b => b > 0).sort((a, b) => a - b);
    const gini = calcGini(balances);
    document.getElementById('giniValue').textContent = gini.toFixed(3);
    
    const n = balances.length || 1;
    const total = balances.reduce((a, b) => a + b, 0) || 1;
    
    const x = [0];
    const equality = [0];
    const actual = [0];
    
    let cumSum = 0;
    balances.forEach((bal, i) => {
        cumSum += bal;
        x.push(((i + 1) / n * 100).toFixed(0));
        equality.push(((i + 1) / n * 100).toFixed(0));
        actual.push((cumSum / total * 100).toFixed(1));
    });
    
    state.charts.lorenz = new Chart(ctx, {
        type: 'line',
        data: {
            labels: x,
            datasets: [
                {
                    label: 'Equality',
                    data: equality,
                    borderColor: chartColors.muted,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0
                },
                {
                    label: 'Actual',
                    data: actual,
                    borderColor: chartColors.gold,
                    backgroundColor: chartColors.goldDim,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.4
                }
            ]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#A9ADB5', font: { size: 9 } }
                }
            },
            scales: {
                x: {
                    ...chartDefaults.scales.x,
                    title: { display: true, text: '% Wallets', color: chartColors.muted, font: { size: 9 } }
                },
                y: {
                    ...chartDefaults.scales.y,
                    title: { display: true, text: '% Wealth', color: chartColors.muted, font: { size: 9 } }
                }
            }
        }
    });
}

function renderEthTables() {
    // Top 10 wallets
    const totalAum = state.ethData.reduce((s, w) => s + w.balance * state.ethPrice, 0);
    const sorted = [...state.ethData]
        .map(w => ({ ...w, usdValue: w.balance * state.ethPrice }))
        .sort((a, b) => b.usdValue - a.usdValue)
        .slice(0, 10);
    
    document.querySelector('#topWalletsTable tbody').innerHTML = sorted.map((w, i) => `
        <tr>
            <td>${i + 1}</td>
            <td class="addr-cell">
                <a href="https://etherscan.io/address/${w.address}" target="_blank">
                    ${w.label || shorten(w.address)}
                </a>
            </td>
            <td>${fmtUsd(w.usdValue)}</td>
            <td>${((w.usdValue / totalAum) * 100).toFixed(1)}%</td>
            <td><span class="tag tag-${w.analyzed?.isActive ? 'active' : 'dormant'}">${w.analyzed?.isActive ? 'Active' : 'Dormant'}</span></td>
        </tr>
    `).join('');
    
    // Segments table
    const segments = {};
    state.ethData.forEach(w => {
        const seg = w.analyzed?.segment || 'Unknown';
        if (!segments[seg]) segments[seg] = { count: 0, totalValue: 0 };
        segments[seg].count++;
        segments[seg].totalValue += w.balance * state.ethPrice;
    });
    
    const total = state.ethData.length;
    document.querySelector('#segmentsTable tbody').innerHTML = Object.entries(segments)
        .sort((a, b) => b[1].count - a[1].count)
        .map(([seg, data]) => `
            <tr>
                <td><span class="tag tag-${seg.toLowerCase()}">${seg}</span></td>
                <td>${data.count}</td>
                <td>${((data.count / total) * 100).toFixed(1)}%</td>
                <td>${fmtUsd(data.totalValue / data.count)}</td>
            </tr>
        `).join('');
    
    // All wallets table
    renderAllEthTable();
}

function renderAllEthTable() {
    const wallets = state.ethData.map(w => ({
        ...w,
        usdValue: w.balance * state.ethPrice
    }));
    
    const col = state.ethTableSort.col;
    const asc = state.ethTableSort.asc;
    
    wallets.sort((a, b) => {
        let va, vb;
        switch (col) {
            case 'address': va = (a.label || a.address).toLowerCase(); vb = (b.label || b.address).toLowerCase(); break;
            case 'value': va = a.usdValue; vb = b.usdValue; break;
            case 'tokens': va = a.analyzed?.tokCount || 0; vb = b.analyzed?.tokCount || 0; break;
            case 'tx': va = a.analyzed?.totalTxCount || 0; vb = b.analyzed?.totalTxCount || 0; break;
            case 'age': va = a.analyzed?.ageDays || 0; vb = b.analyzed?.ageDays || 0; break;
            case 'last': va = a.analyzed?.lastAct?.getTime() || 0; vb = b.analyzed?.lastAct?.getTime() || 0; break;
            default: va = a.usdValue; vb = b.usdValue;
        }
        if (va < vb) return asc ? -1 : 1;
        if (va > vb) return asc ? 1 : -1;
        return 0;
    });
    
    document.querySelector('#allEthTable tbody').innerHTML = wallets.map((w, i) => `
        <tr>
            <td>${i + 1}</td>
            <td class="addr-cell">
                <a href="https://etherscan.io/address/${w.address}" target="_blank">
                    ${w.label || shorten(w.address)}
                </a>
            </td>
            <td style="font-weight: 500;">${fmtUsd(w.usdValue)}</td>
            <td>${w.analyzed?.tokCount || 0}</td>
            <td>${w.analyzed?.totalTxCount || 0}</td>
            <td>${fmtAge(w.analyzed?.ageDays || 0)}</td>
            <td>${w.analyzed?.lastAct ? w.analyzed.lastAct.toLocaleDateString() : '‚Äî'}</td>
            <td style="font-size: 10px; color: ${w.analyzed?.fundingSource === 'Unknown' ? 'var(--text-muted)' : 'var(--gold)'};">
                ${w.analyzed?.fundingSource || 'Unknown'}
            </td>
            <td><span class="tag tag-${(w.analyzed?.segment || 'unknown').toLowerCase()}">${w.analyzed?.segment || 'Unknown'}</span></td>
        </tr>
    `).join('');
}

function sortEthTable(col) {
    if (state.ethTableSort.col === col) {
        state.ethTableSort.asc = !state.ethTableSort.asc;
    } else {
        state.ethTableSort.col = col;
        state.ethTableSort.asc = col === 'address';
    }
    
    document.querySelectorAll('#allEthTable th.sortable').forEach(th => {
        th.classList.remove('active');
        th.querySelector('.sort-icon').textContent = '';
        if (th.dataset.sort === col) {
            th.classList.add('active');
            th.querySelector('.sort-icon').textContent = state.ethTableSort.asc ? '‚ñ≤' : '‚ñº';
        }
    });
    
    renderAllEthTable();
}

function renderBtcDistChart() {
    const ctx = document.getElementById('btcDistChart');
    if (state.charts.btcDist) state.charts.btcDist.destroy();
    
    const sorted = [...state.btcData].sort((a, b) => b.balance - a.balance);
    
    state.charts.btcDist = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(w => w.label || shorten(w.address)),
            datasets: [{
                data: sorted.map(w => w.balance),
                backgroundColor: chartColors.btcDim,
                borderColor: chartColors.btc,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { label: ctx => fmtBtc(ctx.raw) }
                }
            }
        }
    });
}

function renderBtcFlowChart() {
    const ctx = document.getElementById('btcFlowChart');
    if (state.charts.btcFlow) state.charts.btcFlow.destroy();
    
    state.charts.btcFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: state.btcData.map(w => w.label || shorten(w.address)),
            datasets: [
                {
                    label: 'Received',
                    data: state.btcData.map(w => w.totalReceived),
                    backgroundColor: chartColors.successDim,
                    borderColor: chartColors.success,
                    borderWidth: 1
                },
                {
                    label: 'Sent',
                    data: state.btcData.map(w => -w.totalSent),
                    backgroundColor: chartColors.dangerDim,
                    borderColor: chartColors.danger,
                    borderWidth: 1
                }
            ]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#A9ADB5', font: { size: 10 } }
                }
            },
            scales: {
                ...chartDefaults.scales,
                x: { ...chartDefaults.scales.x, stacked: true },
                y: { ...chartDefaults.scales.y, stacked: true }
            }
        }
    });
}

function renderBtcTable() {
    const sorted = [...state.btcData].sort((a, b) => b.balance - a.balance);
    
    document.querySelector('#allBtcTable tbody').innerHTML = sorted.map((w, i) => `
        <tr>
            <td>${i + 1}</td>
            <td class="addr-cell">
                <a href="https://blockstream.info/address/${w.address}" target="_blank">
                    ${w.label || shorten(w.address)}
                </a>
            </td>
            <td>${fmtBtc(w.balance)}</td>
            <td>${fmtUsd(w.balance * state.btcPrice)}</td>
            <td>${w.txCount}</td>
            <td>${fmtBtc(w.totalReceived)}</td>
            <td>${fmtBtc(w.totalSent)}</td>
        </tr>
    `).join('');
}

// ============================================
// TIME SERIES GENERATORS
// ============================================
function generateAumSeries() {
    const now = Date.now();
    const labels = [];
    const values = [];
    
    const currentAum = state.ethData.reduce((s, w) => s + w.balance, 0);
    
    // Collect all transactions
    const allTx = [];
    let oldestTx = now;
    state.ethData.forEach(w => {
        [...(w.rawTx || []), ...(w.rawInternalTx || [])].forEach(tx => {
            const ts = parseInt(tx.timeStamp) * 1000;
            if (ts < oldestTx) oldestTx = ts;
            allTx.push({
                timestamp: ts,
                value: weiToEth(tx.value),
                isIncoming: tx.to?.toLowerCase() === w.address.toLowerCase()
            });
        });
    });
    
    let days = state.period === 0 
        ? Math.min(Math.ceil((now - oldestTx) / 864e5), 365)
        : state.period;
    if (days < 7) days = 7;
    
    if (allTx.length === 0) {
        const step = Math.max(1, Math.floor(days / 30));
        for (let i = days - 1; i >= 0; i -= step) {
            labels.push(new Date(now - i * 864e5).toLocaleDateString('en', { month: 'short', day: 'numeric' }));
            values.push(currentAum);
        }
        return { labels, values };
    }
    
    let runningAum = currentAum;
    const step = Math.max(1, Math.floor(days / 60));
    
    for (let i = 0; i < days; i += step) {
        const dayStart = now - (i + 1) * 864e5;
        const dayEnd = now - i * 864e5;
        
        const rangeTx = allTx.filter(tx => tx.timestamp >= dayStart && tx.timestamp < dayEnd);
        const rangeNetFlow = rangeTx.reduce((s, tx) => s + (tx.isIncoming ? tx.value : -tx.value), 0);
        
        labels.unshift(new Date(dayEnd).toLocaleDateString('en', { month: 'short', day: 'numeric' }));
        values.unshift(Math.max(0, runningAum));
        
        runningAum -= rangeNetFlow;
    }
    
    return { labels, values };
}

function generateFlowSeries() {
    const now = Date.now();
    let oldestTx = now;
    
    state.ethData.forEach(w => {
        [...(w.rawTx || []), ...(w.rawInternalTx || [])].forEach(tx => {
            const ts = parseInt(tx.timeStamp) * 1000;
            if (ts < oldestTx) oldestTx = ts;
        });
    });
    
    let days = state.period === 0 
        ? Math.min(Math.ceil((now - oldestTx) / 864e5), 365)
        : state.period;
    if (days < 7) days = 7;
    
    const weeks = Math.min(Math.ceil(days / 7), 52);
    const labels = [];
    const inflow = [];
    const outflow = [];
    
    for (let i = weeks - 1; i >= 0; i--) {
        const wStart = now - (i + 1) * 7 * 864e5;
        const wEnd = now - i * 7 * 864e5;
        
        let wIn = 0, wOut = 0;
        
        state.ethData.forEach(w => {
            const addr = w.address.toLowerCase();
            [...(w.rawTx || []), ...(w.rawInternalTx || [])].forEach(tx => {
                const ts = parseInt(tx.timeStamp) * 1000;
                if (ts >= wStart && ts < wEnd) {
                    const val = weiToEth(tx.value);
                    if (tx.to?.toLowerCase() === addr) wIn += val;
                    else if (tx.from?.toLowerCase() === addr) wOut += val;
                }
            });
        });
        
        labels.push('W' + (weeks - i));
        inflow.push(wIn);
        outflow.push(wOut);
    }
    
    return { labels, inflow, outflow };
}

// ============================================
// INITIALIZATION
// ============================================
function initSettingsChips() {
    Object.entries(state.visibleStats).forEach(([stat, visible]) => {
        document.querySelectorAll(`.setting-chip[data-stat="${stat}"]`).forEach(el => {
            el.classList.toggle('active', visible);
        });
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    loadState();
    initSettingsChips();
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
    setSegment(state.segment);
    
    // Set initial period display
    const labels = { 7: '7D', 30: '30D', 90: '90D', 365: '1Y', 0: 'All' };
    document.getElementById('periodValue').textContent = labels[state.period] || '30D';
    document.querySelectorAll('.dropdown-item[data-period]').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.period) === state.period);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#periodDropdown')) {
            closePeriodDropdown();
        }
    });
    
    // Fetch prices on load
    await fetchPrices();
    
    // If we have wallets but no data, mark as needs refresh
    if (state.wallets.length > 0 && state.ethData.length === 0 && state.btcData.length === 0) {
        markNeedsRefresh();
    }
    
    document.getElementById('apiStatus').textContent = state.ethPrice > 0 ? 'Ready' : 'Error';
    document.getElementById('apiStatus').className = 'status-value ' + (state.ethPrice > 0 ? 'success' : 'warning');
});
</script>
</body>
</html>
