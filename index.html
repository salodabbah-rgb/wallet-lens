<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet Lens</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230E0F12'/><circle cx='50' cy='50' r='30' fill='none' stroke='%23B8A45A' stroke-width='6'/><circle cx='50' cy='50' r='12' fill='%23B8A45A'/><line x1='72' y1='72' x2='90' y2='90' stroke='%23B8A45A' stroke-width='8' stroke-linecap='round'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0E0F12;
            --bg-card: #1C1F24;
            --bg-card-hover: #252830;
            --bg-input: #15171C;
            --gold: #B8A45A;
            --gold-dim: rgba(184, 164, 90, 0.15);
            --gold-bright: #D4C36A;
            --text: #F4F4F2;
            --text-dim: #A9ADB5;
            --text-muted: #6B7280;
            --border: #2D3139;
            --success: #34D399;
            --warning: #FBBF24;
            --danger: #F87171;
            --info: #60A5FA;
            --eth-color: #627EEA;
            --btc-color: #F7931A;
            --stable-color: #26A17B;
            --sidebar-width: 300px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--gold);
        }

        .logo-sub {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            letter-spacing: 0.05em;
        }

        .logo-sub a {
            color: var(--gold);
            text-decoration: none;
        }

        .logo-sub a:hover { text-decoration: underline; }

        /* Add Wallets Section */
        .add-section {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .section-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .input-wrapper {
            position: relative;
        }

        .address-input {
            width: 100%;
            height: 60px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', monospace;
            font-size: 10px;
            padding: 10px;
            padding-right: 40px;
            resize: none;
            transition: border-color 0.15s;
            overflow: hidden;
        }

        .address-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .address-input::placeholder {
            color: var(--text-muted);
        }

        .btn-paste {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-paste:hover {
            background: var(--gold);
            color: var(--bg);
            border-color: var(--gold);
        }

        .btn-add {
            width: 100%;
            height: 36px;
            margin-top: 10px;
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-add:hover { background: var(--gold-bright); }

        /* Library Section */
        .library-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 14px 0;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 8px;
        }

        .library-title {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .library-title span {
            color: var(--gold);
            font-weight: 500;
        }

        .library-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
            cursor: pointer;
        }

        .btn-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Roboto Condensed', sans-serif;
            padding: 4px;
            letter-spacing: 0.05em;
        }

        .btn-clear:hover { color: var(--danger); }

        .wallet-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px;
        }

        .wallet-list::-webkit-scrollbar { width: 4px; }
        .wallet-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .wallet-list::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .wallet-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 6px;
            transition: all 0.15s;
        }

        .wallet-item:hover {
            border-color: var(--gold-dim);
        }

        .wallet-item.unselected {
            opacity: 0.5;
        }

        .wallet-item-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .wallet-checkbox {
            width: 16px;
            height: 16px;
            appearance: none;
            background: var(--bg);
            border: 1px solid var(--border);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .wallet-checkbox:checked {
            background: var(--gold);
            border-color: var(--gold);
        }

        .wallet-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bg);
            font-size: 10px;
            font-weight: bold;
        }

        .chain-badge {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .chain-badge.eth {
            background: rgba(98, 126, 234, 0.15);
            color: var(--eth-color);
        }

        .chain-badge.btc {
            background: rgba(247, 147, 26, 0.15);
            color: var(--btc-color);
        }

        .wallet-info {
            flex: 1;
            min-width: 0;
        }

        .wallet-label-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 0;
            outline: none;
        }

        .wallet-label-input:hover {
            border-bottom-color: var(--border);
        }

        .wallet-label-input:focus {
            border-bottom-color: var(--gold);
        }

        .wallet-label-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
            font-weight: 400;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            letter-spacing: 0.02em;
        }

        .wallet-item-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
        }

        .wallet-stats {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-balance {
            font-size: 11px;
            font-weight: 500;
            color: var(--text);
        }

        .wallet-balance-usd {
            font-size: 9px;
            color: var(--text-muted);
        }

        .wallet-tokens {
            font-size: 9px;
            color: var(--text-dim);
        }

        .wallet-actions {
            display: flex;
            gap: 6px;
        }

        .wallet-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            padding: 2px;
            transition: color 0.15s;
        }

        .wallet-action:hover { color: var(--gold); }
        .wallet-action.delete:hover { color: var(--danger); }

        .wallet-list-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
        }

        .wallet-list-empty-icon {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .wallet-list-empty-text {
            font-size: 11px;
            line-height: 1.6;
        }

        /* Status Section */
        .status-section {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .status-item:last-child { margin-bottom: 0; }

        .status-label { color: var(--text-muted); font-weight: 400; }
        .status-value { color: var(--text-dim); font-weight: 500; }
        .status-value.success { color: var(--success); }
        .status-value.warning { color: var(--warning); }
        .status-value.eth { color: var(--eth-color); }
        .status-value.btc { color: var(--btc-color); }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 16px;
        }

        .segment-tabs {
            display: flex;
            gap: 0;
        }

        .segment-tab {
            padding: 0 20px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-right: none;
            color: var(--text-dim);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment-tab:last-child { border-right: 1px solid var(--border); }

        .segment-tab:hover {
            color: var(--text);
            border-color: var(--gold);
        }

        .segment-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg);
        }

        .segment-tab.active + .segment-tab {
            border-left-color: var(--gold);
        }

        .segment-tab .count {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .segment-tab.active .count {
            background: rgba(0,0,0,0.2);
            color: var(--bg);
        }

        .top-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 14px;
            height: 36px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-btn:hover,
        .dropdown-btn.open {
            border-color: var(--gold);
        }

        .dropdown-btn .value {
            color: var(--gold);
            font-weight: 600;
        }

        .dropdown-btn .arrow {
            font-size: 8px;
            color: var(--text-muted);
            transition: transform 0.15s;
        }

        .dropdown-btn.open .arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: all 0.15s;
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 14px;
            background: none;
            border: none;
            text-align: left;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-input);
            color: var(--text);
        }

        .dropdown-item.active {
            background: var(--gold-dim);
            color: var(--gold);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-icon:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .btn-icon.spinning {
            animation: spin 1s linear infinite;
        }

        .btn-icon.needs-refresh {
            background: rgba(251, 191, 36, 0.15);
            border-color: var(--warning);
            color: var(--warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); } 
            50% { box-shadow: 0 0 0 6px rgba(251, 191, 36, 0); } 
        }

        .btn-icon.open {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 24px;
        }

        .settings-panel.open { display: block; }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .settings-column h4 {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .settings-column h4.gold { color: var(--gold); border-color: var(--gold-dim); }
        .settings-column h4.eth { color: var(--eth-color); border-color: rgba(98,126,234,0.3); }
        .settings-column h4.btc { color: var(--btc-color); border-color: rgba(247,147,26,0.3); }

        .settings-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .setting-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Roboto Condensed', sans-serif;
            white-space: nowrap;
        }

        .setting-chip:hover {
            border-color: var(--gold);
            color: var(--text);
        }

        .setting-chip.active {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        .chip-check {
            width: 12px;
            height: 12px;
            border: 1px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0;
        }

        .setting-chip.active .chip-check {
            background: var(--gold);
            color: var(--bg);
        }

        /* Dashboard Segments */
        .segment-content {
            display: none;
        }

        .segment-content.active {
            display: block;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
            transition: all 0.15s;
        }

        .kpi-card:hover {
            border-color: var(--gold);
        }

        .kpi-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-badge {
            font-size: 8px;
            padding: 2px 4px;
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 500;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 300;
            color: var(--text);
            margin-bottom: 4px;
        }

        .kpi-value.gold { color: var(--gold); }
        .kpi-value.eth { color: var(--eth-color); }
        .kpi-value.btc { color: var(--btc-color); }
        .kpi-value.stable { color: var(--stable-color); }
        .kpi-value.success { color: var(--success); }
        .kpi-value.danger { color: var(--danger); }

        .kpi-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .kpi-sub.up { color: var(--success); }
        .kpi-sub.down { color: var(--danger); }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .chart-card.full { grid-column: span 2; }

        .chart-header {
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text);
        }

        .chart-subtitle {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-container {
            position: relative;
            height: 220px;
        }

        .chart-container.tall { height: 300px; }
        .chart-container.short { height: 160px; }

        /* Heatmap */
        .heatmap-wrapper {
            overflow-x: auto;
            padding: 8px 0;
        }

        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 550px;
        }

        .heatmap-row {
            display: grid;
            grid-template-columns: 40px repeat(24, 1fr);
            gap: 2px;
        }

        .heatmap-header {
            margin-bottom: 4px;
        }

        .heatmap-hour {
            font-size: 8px;
            color: var(--text-muted);
            text-align: center;
        }

        .heatmap-label {
            font-size: 9px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.03);
            border-radius: 2px;
            min-width: 14px;
            min-height: 14px;
        }

        .heatmap-cell.l1 { background: rgba(184, 164, 90, 0.2); }
        .heatmap-cell.l2 { background: rgba(184, 164, 90, 0.4); }
        .heatmap-cell.l3 { background: rgba(184, 164, 90, 0.6); }
        .heatmap-cell.l4 { background: rgba(184, 164, 90, 0.8); }
        .heatmap-cell.l5 { background: var(--gold); }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover { color: var(--gold); }

        th .sort-icon {
            margin-left: 4px;
            font-size: 8px;
            opacity: 0.4;
        }

        th.active .sort-icon { opacity: 1; color: var(--gold); }

        td {
            padding: 10px 12px;
            font-size: 12px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        tr:hover td { background: var(--bg-input); }

        .addr-cell {
            font-family: monospace;
            font-size: 11px;
        }

        .addr-cell a {
            color: var(--text);
            text-decoration: none;
        }

        .addr-cell a:hover { color: var(--gold); }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tag-whale { background: var(--gold-dim); color: var(--gold); }
        .tag-active { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .tag-dormant { background: rgba(107, 114, 128, 0.15); color: var(--text-muted); }
        .tag-trader { background: rgba(96, 165, 250, 0.15); color: var(--info); }
        .tag-hodler { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .tag-defi { background: rgba(167, 139, 250, 0.15); color: #A78BFA; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .empty-icon {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .empty-btn {
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 600;
            padding: 12px 28px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .empty-btn:hover { background: var(--gold-bright); }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(14, 15, 18, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .loading-progress {
            margin-top: 8px;
            font-size: 12px;
            color: var(--gold);
            font-family: monospace;
        }

        /* Data Warnings */
        .data-warnings {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 150;
            max-width: 380px;
        }

        .data-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--warning);
            border-left: 3px solid var(--warning);
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 11px;
            color: var(--text);
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .data-warning-title {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .data-warning-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
        }

        .data-warning-close:hover { color: var(--text); }

        /* Mobile Header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-brand {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--gold);
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        /* Mobile Add Wallet Bar - Always Visible */
        .mobile-add-bar {
            display: none;
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            z-index: 99;
        }

        .mobile-add-bar .input-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .mobile-add-bar .address-input-mobile {
            flex: 1;
            height: 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Roboto Condensed', monospace;
            font-size: 13px;
            padding: 0 12px;
            transition: border-color 0.15s;
        }

        .mobile-add-bar .address-input-mobile:focus {
            outline: none;
            border-color: var(--gold);
        }

        .mobile-add-bar .address-input-mobile::placeholder {
            color: var(--text-muted);
        }

        .mobile-add-bar .btn-paste-mobile {
            width: 44px;
            height: 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-add-bar .btn-paste-mobile:hover,
        .mobile-add-bar .btn-paste-mobile:active {
            background: var(--gold);
            color: var(--bg);
            border-color: var(--gold);
        }

        .mobile-add-bar .btn-add-mobile {
            height: 44px;
            padding: 0 16px;
            background: var(--gold);
            border: none;
            color: var(--bg);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .mobile-add-bar .btn-add-mobile:hover,
        .mobile-add-bar .btn-add-mobile:active {
            background: var(--gold-bright);
        }

        .mobile-wallet-count {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .mobile-wallet-count .count-info {
            font-size: 11px;
            color: var(--text-muted);
        }

        .mobile-wallet-count .count-info span {
            color: var(--gold);
            font-weight: 600;
        }

        .mobile-wallet-count .btn-library {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 12px;
            font-size: 11px;
            font-family: 'Roboto Condensed', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mobile-wallet-count .btn-library:hover,
        .mobile-wallet-count .btn-library:active {
            border-color: var(--gold);
            color: var(--gold);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 45;
        }

        .sidebar-overlay.active { display: block; }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .settings-grid { grid-template-columns: 1fr; gap: 16px; }
        }

        @media (max-width: 900px) {
            .chart-grid { grid-template-columns: 1fr; }
            .chart-card.full { grid-column: span 1; }
        }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .mobile-add-bar { display: block; }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open { transform: translateX(0); }
            
            .main {
                margin-left: 0;
                padding: 16px;
                padding-top: 180px; /* Header 56px + Add bar ~124px */
            }

            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .segment-tabs {
                order: 1;
                justify-content: center;
            }

            .top-controls {
                order: 2;
                justify-content: center;
                flex-wrap: wrap;
            }

            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .kpi-card { padding: 14px; }
            .kpi-value { font-size: 20px; }
        }

        @media (max-width: 480px) {
            .segment-tab { padding: 0 12px; font-size: 11px; height: 32px; }
            .dropdown-btn { height: 32px; }
            .btn-icon { width: 32px; height: 32px; }
            .kpi-grid { gap: 8px; }
            .kpi-card { padding: 12px; }
            .kpi-label { font-size: 8px; }
            .kpi-value { font-size: 18px; }
            .kpi-sub { font-size: 10px; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing wallets...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <!-- Data Warnings -->
    <div class="data-warnings" id="dataWarnings"></div>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-brand">WALLET LENS</div>
        <button class="menu-btn" onclick="toggleSidebar()" title="Open Library">‚ò∞</button>
    </header>

    <!-- Mobile Add Wallet Bar -->
    <div class="mobile-add-bar" id="mobileAddBar">
        <div class="input-row">
            <input type="text" class="address-input-mobile" id="mobileAddressInput" 
                   placeholder="0x... / vitalik.eth / bc1q..." 
                   onkeypress="handleMobileEnter(event)">
            <button class="btn-paste-mobile" onclick="pasteFromClipboardMobile()" title="Paste">üìã</button>
            <button class="btn-add-mobile" onclick="addWalletsMobile()">+ Add</button>
        </div>
        <div class="mobile-wallet-count">
            <div class="count-info">
                <span id="mobileWalletCount">0</span> wallets tracked
            </div>
            <button class="btn-library" onclick="toggleSidebar()">üìö View Library</button>
        </div>
    </div>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-text">WALLET LENS</div>
                <div class="logo-sub">by <a href="https://twitter.com/beto_neh" target="_blank">@beto_neh</a></div>
            </div>

            <div class="add-section">
                <div class="section-label">Add Wallets</div>
                <div class="input-wrapper">
                    <textarea class="address-input" id="addressInput" placeholder="Paste addresses here&#10;0x... / vitalik.eth&#10;bc1q... / 3...&#10;Auto-detects chain"></textarea>
                    <button class="btn-paste" onclick="pasteFromClipboard()" title="Paste">üìã</button>
                </div>
                <button class="btn-add" onclick="addWallets()">+ Add to Library</button>
            </div>

            <div class="library-section">
                <div class="library-header">
                    <div class="library-title">LIBRARY <span id="libraryCount">(0)</span></div>
                    <div class="library-controls">
                        <select class="filter-select" id="libraryFilter" onchange="renderWalletList()">
                            <option value="all">All</option>
                            <option value="eth">ETH Only</option>
                            <option value="btc">BTC Only</option>
                            <option value="selected">Selected</option>
                        </select>
                        <button class="btn-clear" onclick="clearAllWallets()">Clear</button>
                    </div>
                </div>
                <div class="wallet-list" id="walletList">
                    <div class="wallet-list-empty">
                        <div class="wallet-list-empty-icon">üìã</div>
                        <div class="wallet-list-empty-text">No wallets yet.<br>Add addresses above to start.</div>
                    </div>
                </div>
            </div>

            <div class="status-section">
                <div class="status-item">
                    <span class="status-label">API Status</span>
                    <span class="status-value success" id="apiStatus">Ready</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ETH Price</span>
                    <span class="status-value eth" id="ethPriceDisplay">‚Äî</span>
                </div>
                <div class="status-item">
                    <span class="status-label">BTC Price</span>
                    <span class="status-value btc" id="btcPriceDisplay">‚Äî</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update</span>
                    <span class="status-value" id="lastUpdate">‚Äî</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="top-bar">
                <div class="segment-tabs">
                    <button class="segment-tab active" data-segment="combined" onclick="setSegment('combined')">
                        Combined <span class="count" id="countCombined">0</span>
                    </button>
                    <button class="segment-tab" data-segment="eth" onclick="setSegment('eth')">
                        Ethereum <span class="count" id="countEth">0</span>
                    </button>
                    <button class="segment-tab" data-segment="btc" onclick="setSegment('btc')">
                        Bitcoin <span class="count" id="countBtc">0</span>
                    </button>
                </div>

                <div class="top-controls">
                    <div class="dropdown" id="periodDropdown">
                        <button class="dropdown-btn" onclick="togglePeriodDropdown()">
                            <span class="value" id="periodValue">All</span>
                            <span class="arrow">‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="periodMenu">
                            <button class="dropdown-item" data-period="7" onclick="setPeriod(7)">7 Days</button>
                            <button class="dropdown-item" data-period="30" onclick="setPeriod(30)">30 Days</button>
                            <button class="dropdown-item" data-period="90" onclick="setPeriod(90)">90 Days</button>
                            <button class="dropdown-item active" data-period="180" onclick="setPeriod(180)">6 Months</button>
                            <button class="dropdown-item" data-period="365" onclick="setPeriod(365)">1 Year</button>
                            <button class="dropdown-item" data-period="0" onclick="setPeriod(0)">All Time</button>
                        </div>
                    </div>
                    <button class="btn-icon" id="refreshBtn" onclick="runAnalysis()" title="Refresh Analysis">‚Üª</button>
                    <button class="btn-icon" id="settingsBtn" onclick="toggleSettings()" title="Settings">‚öô</button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel">
                <div class="settings-grid">
                    <div class="settings-column">
                        <h4 class="gold">Combined (USD)</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="combined-kpis" onclick="toggleStat('combined-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="combined-allocation" onclick="toggleStat('combined-allocation')">
                                <span class="chip-check">‚úì</span> Portfolio Allocation
                            </button>
                            <button class="setting-chip active" data-stat="combined-flow" onclick="toggleStat('combined-flow')">
                                <span class="chip-check">‚úì</span> Capital Flow
                            </button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h4 class="eth">Ethereum</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="eth-kpis" onclick="toggleStat('eth-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="eth-aum" onclick="toggleStat('eth-aum')">
                                <span class="chip-check">‚úì</span> AUM Chart
                            </button>
                            <button class="setting-chip active" data-stat="eth-distribution" onclick="toggleStat('eth-distribution')">
                                <span class="chip-check">‚úì</span> Balance Distribution
                            </button>
                            <button class="setting-chip active" data-stat="eth-flow" onclick="toggleStat('eth-flow')">
                                <span class="chip-check">‚úì</span> Net Flow
                            </button>
                            <button class="setting-chip active" data-stat="eth-tokens" onclick="toggleStat('eth-tokens')">
                                <span class="chip-check">‚úì</span> Top Tokens
                            </button>
                            <button class="setting-chip active" data-stat="eth-segments" onclick="toggleStat('eth-segments')">
                                <span class="chip-check">‚úì</span> Segmentation
                            </button>
                            <button class="setting-chip active" data-stat="eth-heatmap" onclick="toggleStat('eth-heatmap')">
                                <span class="chip-check">‚úì</span> Activity Heatmap
                            </button>
                            <button class="setting-chip active" data-stat="eth-lorenz" onclick="toggleStat('eth-lorenz')">
                                <span class="chip-check">‚úì</span> Lorenz Curve
                            </button>
                            <button class="setting-chip active" data-stat="eth-tables" onclick="toggleStat('eth-tables')">
                                <span class="chip-check">‚úì</span> Tables
                            </button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h4 class="btc">Bitcoin</h4>
                        <div class="settings-options">
                            <button class="setting-chip active" data-stat="btc-kpis" onclick="toggleStat('btc-kpis')">
                                <span class="chip-check">‚úì</span> KPIs
                            </button>
                            <button class="setting-chip active" data-stat="btc-distribution" onclick="toggleStat('btc-distribution')">
                                <span class="chip-check">‚úì</span> Balance Distribution
                            </button>
                            <button class="setting-chip active" data-stat="btc-flow" onclick="toggleStat('btc-flow')">
                                <span class="chip-check">‚úì</span> Flow Chart
                            </button>
                            <button class="setting-chip active" data-stat="btc-table" onclick="toggleStat('btc-table')">
                                <span class="chip-check">‚úì</span> Wallet Table
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Segment -->
            <div class="segment-content active" id="segment-combined">
                <div id="combined-empty" class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-title">No Data Yet</div>
                    <div class="empty-text">Add wallets to your library and click Refresh to analyze.</div>
                </div>
                <div id="combined-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="combined-kpis-section">
                        <div class="kpi-grid" id="combinedKpis"></div>
                    </div>
                    <!-- Allocation Chart -->
                    <div id="combined-allocation-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Portfolio Allocation</div>
                                <div class="chart-subtitle">Distribution by asset type</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="allocationChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Value by Chain</div>
                                <div class="chart-subtitle">ETH vs BTC holdings</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chainChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Capital Flow -->
                    <div id="combined-flow-section" class="chart-grid">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">Combined Capital Flow</div>
                                <div class="chart-subtitle">Weekly inflows vs outflows (ETH only, timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container tall">
                                <canvas id="combinedFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ethereum Segment -->
            <div class="segment-content" id="segment-eth">
                <div id="eth-empty" class="empty-state">
                    <div class="empty-icon">Œû</div>
                    <div class="empty-title">No Ethereum Wallets</div>
                    <div class="empty-text">Add ETH addresses to see Ethereum analytics.</div>
                </div>
                <div id="eth-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="eth-kpis-section">
                        <div class="kpi-grid" id="ethKpis"></div>
                    </div>
                    <!-- AUM Chart -->
                    <div id="eth-aum-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">AUM Over Time</div>
                                <div class="chart-subtitle">Estimated historical balance (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container tall">
                                <canvas id="aumChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Distribution & Flow -->
                    <div id="eth-distribution-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Balance Distribution</div>
                                <div class="chart-subtitle">Wallets by ETH range</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="balanceDistChart"></canvas>
                            </div>
                        </div>
                        <div id="eth-flow-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Net Flow Analysis</div>
                                <div class="chart-subtitle">Weekly inflows vs outflows (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="netFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Tokens & Segments -->
                    <div id="eth-tokens-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Top 10 Tokens</div>
                                <div class="chart-subtitle">By USD value</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="topTokensChart"></canvas>
                            </div>
                        </div>
                        <div id="eth-segments-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">User Segmentation</div>
                                <div class="chart-subtitle">By behavior pattern (timeframe-adjusted)</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="segmentChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Token List Table -->
                    <div id="eth-tokenlist-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All Token Holdings</div>
                                <div class="chart-subtitle">Complete token breakdown with USD values</div>
                            </div>
                            <div class="table-container">
                                <table id="allTokensTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Token</th>
                                            <th style="text-align: right;">Balance</th>
                                            <th style="text-align: right;">Price</th>
                                            <th style="text-align: right;">USD Value</th>
                                            <th style="text-align: right;">% of Tokens</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Heatmap & Lorenz -->
                    <div id="eth-heatmap-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Activity Heatmap</div>
                                <div class="chart-subtitle">Transaction frequency by day/hour (UTC, timeframe-adjusted)</div>
                            </div>
                            <div class="heatmap-wrapper">
                                <div class="heatmap-grid" id="heatmapGrid"></div>
                            </div>
                        </div>
                        <div id="eth-lorenz-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Capital Concentration</div>
                                <div class="chart-subtitle">Lorenz curve ¬∑ Gini: <span id="giniValue">‚Äî</span></div>
                            </div>
                            <div class="chart-container">
                                <canvas id="lorenzChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Tables -->
                    <div id="eth-tables-section" class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Top 10 Wallets</div>
                                <div class="chart-subtitle">By total USD value</div>
                            </div>
                            <div class="table-container">
                                <table id="topWalletsTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Address</th>
                                            <th>Value</th>
                                            <th>% AUM</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Segment Breakdown</div>
                                <div class="chart-subtitle">Wallets by behavior type</div>
                            </div>
                            <div class="table-container">
                                <table id="segmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Segment</th>
                                            <th>Count</th>
                                            <th>%</th>
                                            <th>Avg Value</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All ETH Wallets</div>
                                <div class="chart-subtitle">Complete breakdown</div>
                            </div>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table id="allEthTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th class="sortable" data-sort="address" onclick="sortEthTable('address')">Address <span class="sort-icon"></span></th>
                                            <th class="sortable active" data-sort="value" onclick="sortEthTable('value')">Value <span class="sort-icon">‚ñº</span></th>
                                            <th class="sortable" data-sort="tokens" onclick="sortEthTable('tokens')">Tokens <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="tx" onclick="sortEthTable('tx')">Tx <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="age" onclick="sortEthTable('age')">Age <span class="sort-icon"></span></th>
                                            <th class="sortable" data-sort="last" onclick="sortEthTable('last')">Last Active <span class="sort-icon"></span></th>
                                            <th>Funding</th>
                                            <th>Segment</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bitcoin Segment -->
            <div class="segment-content" id="segment-btc">
                <div id="btc-empty" class="empty-state">
                    <div class="empty-icon">‚Çø</div>
                    <div class="empty-title">No Bitcoin Wallets</div>
                    <div class="empty-text">Add BTC addresses to see Bitcoin analytics.</div>
                </div>
                <div id="btc-content" style="display: none;">
                    <!-- KPIs -->
                    <div id="btc-kpis-section">
                        <div class="kpi-grid" id="btcKpis"></div>
                    </div>
                    <!-- Distribution & Flow -->
                    <div id="btc-distribution-section" class="chart-grid" style="margin-bottom: 24px;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Balance Distribution</div>
                                <div class="chart-subtitle">BTC by wallet</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="btcDistChart"></canvas>
                            </div>
                        </div>
                        <div id="btc-flow-card" class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Flow Analysis</div>
                                <div class="chart-subtitle">Total received vs sent</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="btcFlowChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Table -->
                    <div id="btc-table-section" class="chart-grid">
                        <div class="chart-card full">
                            <div class="chart-header">
                                <div class="chart-title">All BTC Wallets</div>
                                <div class="chart-subtitle">Complete breakdown</div>
                            </div>
                            <div class="table-container">
                                <table id="allBtcTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Address</th>
                                            <th>Balance</th>
                                            <th>USD Value</th>
                                            <th>Tx Count</th>
                                            <th>Total Received</th>
                                            <th>Total Sent</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    ETHERSCAN_API: 'https://api.etherscan.io/api',
    ETHERSCAN_KEY: 'YourEtherscanApiKey', // Get free key at etherscan.io/apis
    BLOCKSTREAM_API: 'https://blockstream.info/api',
    COINGECKO_API: 'https://api.coingecko.com/api/v3',
    DEFAULT_DAYS: 180, // 6 months
    DELAY_MS: 300,
    STABLECOINS: ['usdt', 'usdc', 'dai', 'busd', 'tusd', 'frax', 'lusd'],
    TOKEN_IDS: {
        'USDT': 'tether', 'USDC': 'usd-coin', 'DAI': 'dai', 'WETH': 'weth',
        'WBTC': 'wrapped-bitcoin', 'LINK': 'chainlink', 'UNI': 'uniswap',
        'AAVE': 'aave', 'MKR': 'maker', 'LDO': 'lido-dao', 'SHIB': 'shiba-inu',
        'PEPE': 'pepe', 'ARB': 'arbitrum', 'OP': 'optimism', 'MATIC': 'matic-network',
        'STETH': 'staked-ether', 'RETH': 'rocket-pool-eth', 'CRV': 'curve-dao-token',
        'ENS': 'ethereum-name-service', 'GRT': 'the-graph', 'SNX': 'havven',
        'COMP': 'compound-governance-token', 'SUSHI': 'sushi', 'YFI': 'yearn-finance'
    }
};

// ============================================
// STATE
// ============================================
let state = {
    wallets: [],
    ethData: [],
    btcData: [],
    prices: { eth: 0, btc: 0, tokens: {} },
    period: CONFIG.DEFAULT_DAYS,
    segment: 'combined',
    visibleStats: {
        'combined-kpis': true, 'combined-allocation': true, 'combined-flow': true,
        'eth-kpis': true, 'eth-aum': true, 'eth-distribution': true, 'eth-flow': true,
        'eth-tokens': true, 'eth-tokenlist': true, 'eth-segments': true, 'eth-heatmap': true,
        'eth-lorenz': true, 'eth-tables': true,
        'btc-kpis': true, 'btc-distribution': true, 'btc-flow': true, 'btc-table': true
    },
    charts: {},
    loading: false
};

// ============================================
// UTILITIES
// ============================================
const delay = ms => new Promise(r => setTimeout(r, ms));

function weiToEth(wei) {
    if (!wei) return 0;
    // Handle large numbers by using string manipulation
    const weiStr = wei.toString();
    if (weiStr.length <= 18) {
        return parseFloat(weiStr) / 1e18;
    }
    // For large numbers, split into eth and decimal parts
    const ethPart = weiStr.slice(0, -18) || '0';
    const decPart = weiStr.slice(-18).padStart(18, '0');
    return parseFloat(ethPart + '.' + decPart);
}

const satToBtc = sat => sat / 1e8;
const shorten = (s, start = 6, end = 4) => s ? `${s.slice(0, start)}...${s.slice(-end)}` : '';
const fmt = (n, d = 2) => n?.toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d }) || '0';
const fmtUsd = n => '$' + fmt(n, 2);
const fmtEth = n => fmt(n, 4) + ' ETH';
const fmtBtc = n => fmt(n, 6) + ' BTC';

function isEthAddress(addr) {
    return /^0x[a-fA-F0-9]{40}$/.test(addr);
}

function isBtcAddress(addr) {
    return /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,62}$/.test(addr);
}

function isENS(name) {
    return name?.endsWith('.eth');
}

function detectChain(addr) {
    if (isEthAddress(addr)) return 'eth';
    if (isBtcAddress(addr)) return 'btc';
    if (isENS(addr)) return 'eth';
    return null;
}

function getCutoffTimestamp() {
    if (state.period === 0) return 0;
    return Math.floor((Date.now() - state.period * 24 * 60 * 60 * 1000) / 1000);
}

// ============================================
// LOCAL STORAGE
// ============================================
function saveState() {
    try {
        localStorage.setItem('walletLens', JSON.stringify({
            wallets: state.wallets,
            period: state.period,
            segment: state.segment,
            visibleStats: state.visibleStats
        }));
    } catch (e) { console.error('Save error:', e); }
}

function loadState() {
    try {
        const saved = JSON.parse(localStorage.getItem('walletLens') || '{}');
        if (saved.wallets) state.wallets = saved.wallets;
        if (saved.period !== undefined) state.period = saved.period;
        if (saved.segment) state.segment = saved.segment;
        if (saved.visibleStats) state.visibleStats = { ...state.visibleStats, ...saved.visibleStats };
    } catch (e) { console.error('Load error:', e); }
}

// ============================================
// API CALLS
// ============================================
async function etherscanFetch(params) {
    const url = new URL(CONFIG.ETHERSCAN_API);
    url.searchParams.set('apikey', CONFIG.ETHERSCAN_KEY);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    
    console.log('Etherscan request:', params.action, params.address?.slice(0, 10));
    
    try {
        const res = await fetch(url);
        const data = await res.json();
        
        console.log('Etherscan response:', params.action, data.status, data.message);
        
        if (data.status === '1') {
            return data.result;
        }
        if (data.message === 'OK' || data.message === 'No transactions found') {
            return data.result || [];
        }
        
        console.warn('Etherscan error:', data.message, data.result);
        return null;
    } catch (e) {
        console.error('Etherscan fetch error:', e);
        return null;
    }
}

async function resolveENS(name) {
    try {
        const res = await fetch(`https://api.ensideas.com/ens/resolve/${name}`);
        const data = await res.json();
        return data.address || null;
    } catch (e) {
        console.error('ENS error:', e);
        return null;
    }
}

async function fetchPrices() {
    try {
        // Fetch ETH and BTC prices
        const res = await fetch(`${CONFIG.COINGECKO_API}/simple/price?ids=ethereum,bitcoin&vs_currencies=usd`);
        const data = await res.json();
        state.prices.eth = data.ethereum?.usd || 0;
        state.prices.btc = data.bitcoin?.usd || 0;
        
        document.getElementById('ethPriceDisplay').textContent = fmtUsd(state.prices.eth);
        document.getElementById('btcPriceDisplay').textContent = fmtUsd(state.prices.btc);
        
        // Fetch token prices
        const tokenIds = Object.values(CONFIG.TOKEN_IDS).join(',');
        const tokenRes = await fetch(`${CONFIG.COINGECKO_API}/simple/price?ids=${tokenIds}&vs_currencies=usd`);
        const tokenData = await tokenRes.json();
        
        Object.entries(CONFIG.TOKEN_IDS).forEach(([symbol, id]) => {
            if (tokenData[id]?.usd) {
                state.prices.tokens[symbol] = tokenData[id].usd;
            }
        });
        
        // Stablecoins = $1
        CONFIG.STABLECOINS.forEach(s => {
            state.prices.tokens[s.toUpperCase()] = 1;
        });
        
    } catch (e) {
        console.error('Price fetch error:', e);
    }
}

// ============================================
// WALLET DATA FETCHING
// ============================================
async function fetchEthWallet(address) {
    const cutoff = getCutoffTimestamp();
    const result = {
        address,
        balance: 0,
        balanceUsd: 0,
        tokens: [],
        transactions: [],
        inflow: 0,
        outflow: 0,
        gasSpent: 0,
        txCount: 0
    };

    // 1. Get ETH balance
    const balance = await etherscanFetch({
        module: 'account',
        action: 'balance',
        address,
        tag: 'latest'
    });
    
    console.log('Raw balance response:', balance);
    
    if (balance !== null && balance !== undefined) {
        result.balance = weiToEth(balance);
        result.balanceUsd = result.balance * state.prices.eth;
        console.log('Parsed balance:', result.balance, 'ETH, USD:', result.balanceUsd);
    }
    await delay(CONFIG.DELAY_MS);

    // 2. Get normal transactions (ALL, then filter by period for metrics)
    const txList = await etherscanFetch({
        module: 'account',
        action: 'txlist',
        address,
        startblock: 0,
        endblock: 99999999,
        sort: 'desc'
    });
    
    console.log('Transactions found:', txList?.length || 0);
    
    if (txList && Array.isArray(txList)) {
        const addrLower = address.toLowerCase();
        
        txList.forEach(tx => {
            const timestamp = parseInt(tx.timeStamp);
            
            // Store all transactions for heatmap
            result.transactions.push({
                timestamp,
                value: weiToEth(tx.value),
                from: tx.from,
                to: tx.to,
                type: 'normal'
            });
            
            // Only count inflow/outflow for selected period
            if (cutoff > 0 && timestamp < cutoff) return;
            
            const value = weiToEth(tx.value);
            const gasUsed = tx.gasUsed && tx.gasPrice ? 
                weiToEth(BigInt(tx.gasUsed) * BigInt(tx.gasPrice)) : 0;
            
            if (tx.to?.toLowerCase() === addrLower) {
                result.inflow += value;
            }
            if (tx.from?.toLowerCase() === addrLower) {
                result.outflow += value;
                result.gasSpent += gasUsed;
            }
        });
        
        // txCount is for the period
        result.txCount = txList.filter(tx => {
            if (cutoff === 0) return true;
            return parseInt(tx.timeStamp) >= cutoff;
        }).length;
    }
    await delay(CONFIG.DELAY_MS);

    // 3. Get token transfers (ALL, to calculate current balances)
    const tokenTx = await etherscanFetch({
        module: 'account',
        action: 'tokentx',
        address,
        startblock: 0,
        endblock: 99999999,
        sort: 'desc'
    });
    
    console.log('Token transfers found:', tokenTx?.length || 0);
    
    if (tokenTx && Array.isArray(tokenTx)) {
        const tokenMap = new Map();
        const addrLower = address.toLowerCase();
        
        tokenTx.forEach(tx => {
            const symbol = (tx.tokenSymbol || 'UNKNOWN').toUpperCase();
            const decimals = parseInt(tx.tokenDecimal) || 18;
            const value = parseFloat(tx.value) / Math.pow(10, decimals);
            const contract = tx.contractAddress?.toLowerCase();
            
            if (!tokenMap.has(symbol)) {
                tokenMap.set(symbol, {
                    symbol,
                    name: tx.tokenName || symbol,
                    balance: 0,
                    contract
                });
            }
            
            const token = tokenMap.get(symbol);
            if (tx.to?.toLowerCase() === addrLower) {
                token.balance += value;
            } else if (tx.from?.toLowerCase() === addrLower) {
                token.balance -= value;
            }
        });
        
        // Filter positive balances and add USD values
        result.tokens = [...tokenMap.values()]
            .filter(t => t.balance > 0.0001)
            .map(t => ({
                ...t,
                price: state.prices.tokens[t.symbol] || 0,
                valueUsd: t.balance * (state.prices.tokens[t.symbol] || 0)
            }))
            .sort((a, b) => b.valueUsd - a.valueUsd);
        
        console.log('Tokens with balance:', result.tokens.length);
    }

    return result;
}

async function fetchBtcWallet(address) {
    try {
        const res = await fetch(`${CONFIG.BLOCKSTREAM_API}/address/${address}`);
        const data = await res.json();
        
        const funded = data.chain_stats?.funded_txo_sum || 0;
        const spent = data.chain_stats?.spent_txo_sum || 0;
        const balance = satToBtc(funded - spent);
        
        return {
            address,
            balance,
            balanceUsd: balance * state.prices.btc,
            totalReceived: satToBtc(funded),
            totalSent: satToBtc(spent),
            txCount: (data.chain_stats?.tx_count || 0) + (data.mempool_stats?.tx_count || 0)
        };
    } catch (e) {
        console.error('BTC fetch error:', e);
        return {
            address,
            balance: 0,
            balanceUsd: 0,
            totalReceived: 0,
            totalSent: 0,
            txCount: 0
        };
    }
}

// ============================================
// MAIN ANALYSIS
// ============================================
async function runAnalysis() {
    const selected = state.wallets.filter(w => w.selected);
    if (selected.length === 0) {
        alert('Select at least one wallet to analyze');
        return;
    }
    
    showLoading('Fetching prices...');
    await fetchPrices();
    
    state.ethData = [];
    state.btcData = [];
    
    const ethWallets = selected.filter(w => w.chain === 'eth');
    const btcWallets = selected.filter(w => w.chain === 'btc');
    
    // Fetch ETH wallets
    for (let i = 0; i < ethWallets.length; i++) {
        const w = ethWallets[i];
        updateLoading(`ETH ${i + 1}/${ethWallets.length}: ${shorten(w.address)}`);
        
        try {
            const data = await fetchEthWallet(w.address);
            data.label = w.label;
            state.ethData.push(data);
            
            // Update library
            w.balance = data.balance;
            w.tokenCount = data.tokens.length;
        } catch (e) {
            console.error('ETH wallet error:', e);
        }
    }
    
    // Fetch BTC wallets
    for (let i = 0; i < btcWallets.length; i++) {
        const w = btcWallets[i];
        updateLoading(`BTC ${i + 1}/${btcWallets.length}: ${shorten(w.address)}`);
        
        try {
            const data = await fetchBtcWallet(w.address);
            data.label = w.label;
            state.btcData.push(data);
            w.balance = data.balance;
        } catch (e) {
            console.error('BTC wallet error:', e);
        }
        
        await delay(100);
    }
    
    hideLoading();
    saveState();
    renderWalletList();
    renderDashboard();
    
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    document.getElementById('apiStatus').textContent = 'Ready';
    document.getElementById('apiStatus').className = 'status-value success';
}

// ============================================
// UI FUNCTIONS
// ============================================
function showLoading(text = 'Loading...') {
    state.loading = true;
    document.getElementById('loadingOverlay').classList.add('active');
    document.querySelector('.loading-text').textContent = text;
    document.getElementById('loadingProgress').textContent = '';
}

function updateLoading(text) {
    document.getElementById('loadingProgress').textContent = text;
}

function hideLoading() {
    state.loading = false;
    document.getElementById('loadingOverlay').classList.remove('active');
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('active');
}

function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('open');
    document.getElementById('settingsBtn').classList.toggle('open');
}

function toggleStat(stat) {
    state.visibleStats[stat] = !state.visibleStats[stat];
    document.querySelectorAll(`.setting-chip[data-stat="${stat}"]`).forEach(el => {
        el.classList.toggle('active', state.visibleStats[stat]);
    });
    updateStatVisibility();
    saveState();
}

function updateStatVisibility() {
    Object.entries(state.visibleStats).forEach(([stat, visible]) => {
        const section = document.getElementById(`${stat}-section`);
        const card = document.getElementById(`${stat}-card`);
        if (section) section.style.display = visible ? '' : 'none';
        if (card) card.style.display = visible ? '' : 'none';
    });
}

function setSegment(seg) {
    state.segment = seg;
    document.querySelectorAll('.segment-tab').forEach(el => {
        el.classList.toggle('active', el.dataset.segment === seg);
    });
    document.querySelectorAll('.segment-content').forEach(el => {
        el.classList.toggle('active', el.id === `segment-${seg}`);
    });
    saveState();
}

function togglePeriodDropdown() {
    document.querySelector('#periodDropdown .dropdown-btn').classList.toggle('open');
    document.getElementById('periodMenu').classList.toggle('open');
}

function closePeriodDropdown() {
    document.querySelector('#periodDropdown .dropdown-btn').classList.remove('open');
    document.getElementById('periodMenu').classList.remove('open');
}

function setPeriod(days) {
    state.period = days;
    const labels = { 7: '7D', 30: '30D', 90: '90D', 180: '6M', 365: '1Y', 0: 'All' };
    document.getElementById('periodValue').textContent = labels[days] || '6M';
    document.querySelectorAll('.dropdown-item[data-period]').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.period) === days);
    });
    closePeriodDropdown();
    saveState();
    
    // Re-run if we have data
    if (state.ethData.length > 0 || state.btcData.length > 0) {
        runAnalysis();
    }
}

// ============================================
// WALLET MANAGEMENT
// ============================================
async function pasteFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('addressInput').value = text;
    } catch (e) { console.error('Clipboard error:', e); }
}

async function pasteFromClipboardMobile() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('mobileAddressInput').value = text;
    } catch (e) { console.error('Clipboard error:', e); }
}

function handleMobileEnter(e) {
    if (e.key === 'Enter') addWalletsMobile();
}

async function addWalletsMobile() {
    const input = document.getElementById('mobileAddressInput');
    await processAddWallet(input.value);
    input.value = '';
}

async function addWallets() {
    const input = document.getElementById('addressInput');
    await processAddWallet(input.value);
    input.value = '';
}

async function processAddWallet(inputValue) {
    const lines = inputValue.split(/[\n,]/).map(l => l.trim()).filter(l => l);
    let added = false;
    
    for (const line of lines) {
        let address = line;
        let chain = detectChain(line);
        
        // Resolve ENS
        if (isENS(line)) {
            showLoading('Resolving ENS...');
            const resolved = await resolveENS(line);
            hideLoading();
            if (resolved) {
                address = resolved;
                chain = 'eth';
            } else {
                alert(`Could not resolve ${line}`);
                continue;
            }
        }
        
        if (!chain) {
            alert(`Invalid address: ${line}`);
            continue;
        }
        
        // Check duplicates
        if (state.wallets.some(w => w.address.toLowerCase() === address.toLowerCase())) {
            continue;
        }
        
        state.wallets.push({
            address,
            chain,
            label: isENS(line) ? line : '',
            selected: true,
            addedAt: Date.now(),
            balance: null,
            tokenCount: null
        });
        added = true;
    }
    
    if (added) {
        saveState();
        renderWalletList();
        updateCounts();
        updateMobileWalletCount();
        
        // Auto-refresh
        await runAnalysis();
    }
}

function removeWallet(address) {
    state.wallets = state.wallets.filter(w => w.address !== address);
    saveState();
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
}

function toggleWalletSelection(address) {
    const wallet = state.wallets.find(w => w.address === address);
    if (wallet) {
        wallet.selected = !wallet.selected;
        saveState();
        renderWalletList();
        updateCounts();
    }
}

function updateWalletLabel(address, label) {
    const wallet = state.wallets.find(w => w.address === address);
    if (wallet) {
        wallet.label = label;
        saveState();
    }
}

function clearAllWallets() {
    if (confirm('Remove all wallets?')) {
        state.wallets = [];
        state.ethData = [];
        state.btcData = [];
        saveState();
        renderWalletList();
        updateCounts();
        updateMobileWalletCount();
        renderDashboard();
    }
}

function updateMobileWalletCount() {
    const el = document.getElementById('mobileWalletCount');
    if (el) el.textContent = state.wallets.length;
}

function updateCounts() {
    const selected = state.wallets.filter(w => w.selected);
    document.getElementById('countCombined').textContent = selected.length;
    document.getElementById('countEth').textContent = selected.filter(w => w.chain === 'eth').length;
    document.getElementById('countBtc').textContent = selected.filter(w => w.chain === 'btc').length;
}

function renderWalletList() {
    const container = document.getElementById('walletList');
    const filter = document.getElementById('libraryFilter').value;
    
    let wallets = state.wallets;
    if (filter === 'eth') wallets = wallets.filter(w => w.chain === 'eth');
    else if (filter === 'btc') wallets = wallets.filter(w => w.chain === 'btc');
    else if (filter === 'selected') wallets = wallets.filter(w => w.selected);
    
    if (wallets.length === 0) {
        container.innerHTML = `
            <div class="wallet-list-empty">
                <div class="wallet-list-empty-icon">üìã</div>
                <div class="wallet-list-empty-text">No wallets yet.<br>Add addresses above to start.</div>
            </div>
        `;
        document.getElementById('libraryCount').textContent = '(0)';
        return;
    }
    
    container.innerHTML = wallets.map(w => {
        const explorer = w.chain === 'eth' 
            ? `https://etherscan.io/address/${w.address}`
            : `https://mempool.space/address/${w.address}`;
        
        let balanceDisplay = '‚Äî';
        let usdDisplay = '';
        
        if (w.balance !== null) {
            if (w.chain === 'eth') {
                balanceDisplay = fmtEth(w.balance);
                usdDisplay = fmtUsd(w.balance * state.prices.eth);
            } else {
                balanceDisplay = fmtBtc(w.balance);
                usdDisplay = fmtUsd(w.balance * state.prices.btc);
            }
        }
        
        return `
            <div class="wallet-item ${w.selected ? '' : 'unselected'}">
                <div class="wallet-item-top">
                    <input type="checkbox" class="wallet-checkbox" 
                        ${w.selected ? 'checked' : ''} 
                        onchange="toggleWalletSelection('${w.address}')">
                    <div class="chain-badge ${w.chain}">${w.chain === 'eth' ? 'Œû' : '‚Çø'}</div>
                    <div class="wallet-info">
                        <input type="text" class="wallet-label-input" 
                            placeholder="Add label..." 
                            value="${w.label || ''}"
                            onchange="updateWalletLabel('${w.address}', this.value)">
                        <div class="wallet-address">${shorten(w.address)}</div>
                    </div>
                </div>
                <div class="wallet-item-bottom">
                    <div class="wallet-stats">
                        <div class="wallet-balance">${balanceDisplay}</div>
                        ${usdDisplay ? `<div class="wallet-balance-usd">${usdDisplay}</div>` : ''}
                        ${w.tokenCount ? `<div class="wallet-tokens">${w.tokenCount} tokens</div>` : ''}
                    </div>
                    <div class="wallet-actions">
                        <a href="${explorer}" target="_blank" class="wallet-action" title="View on Explorer">üîó</a>
                        <button class="wallet-action delete" onclick="removeWallet('${w.address}')" title="Remove">üóë</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('libraryCount').textContent = `(${state.wallets.length})`;
}

// ============================================
// DASHBOARD RENDERING
// ============================================
function renderDashboard() {
    renderCombinedDashboard();
    renderEthDashboard();
    renderBtcDashboard();
    updateStatVisibility();
}

function renderCombinedDashboard() {
    const hasData = state.ethData.length > 0 || state.btcData.length > 0;
    document.getElementById('combined-empty').style.display = hasData ? 'none' : '';
    document.getElementById('combined-content').style.display = hasData ? '' : 'none';
    if (!hasData) return;
    
    // Calculate totals
    const ethTotal = state.ethData.reduce((s, w) => s + w.balance, 0);
    const btcTotal = state.btcData.reduce((s, w) => s + w.balance, 0);
    const ethUsd = ethTotal * state.prices.eth;
    const btcUsd = btcTotal * state.prices.btc;
    
    // Token values
    let stableUsd = 0;
    let otherTokensUsd = 0;
    state.ethData.forEach(w => {
        w.tokens.forEach(t => {
            if (CONFIG.STABLECOINS.includes(t.symbol.toLowerCase())) {
                stableUsd += t.valueUsd || t.balance;
            } else {
                otherTokensUsd += t.valueUsd || 0;
            }
        });
    });
    
    const totalUsd = ethUsd + btcUsd + stableUsd + otherTokensUsd;
    const netFlowEth = state.ethData.reduce((s, w) => s + (w.inflow - w.outflow), 0);
    const totalTx = state.ethData.reduce((s, w) => s + w.txCount, 0) + 
                    state.btcData.reduce((s, w) => s + w.txCount, 0);
    
    document.getElementById('combinedKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total AUM</div>
            <div class="kpi-value gold">${fmtUsd(totalUsd)}</div>
            <div class="kpi-sub">${state.ethData.length + state.btcData.length} wallets</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">ETH Holdings</div>
            <div class="kpi-value eth">${fmtUsd(ethUsd)}</div>
            <div class="kpi-sub">${fmtEth(ethTotal)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">BTC Holdings</div>
            <div class="kpi-value btc">${fmtUsd(btcUsd)}</div>
            <div class="kpi-sub">${fmtBtc(btcTotal)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Stablecoins</div>
            <div class="kpi-value stable">${fmtUsd(stableUsd)}</div>
            <div class="kpi-sub">${totalUsd > 0 ? ((stableUsd / totalUsd) * 100).toFixed(1) : 0}% of AUM</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Other Tokens</div>
            <div class="kpi-value">${fmtUsd(otherTokensUsd)}</div>
            <div class="kpi-sub">${totalUsd > 0 ? ((otherTokensUsd / totalUsd) * 100).toFixed(1) : 0}% of AUM</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net Flow <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value ${netFlowEth >= 0 ? 'success' : 'danger'}">${netFlowEth >= 0 ? '+' : ''}${fmtEth(netFlowEth)}</div>
            <div class="kpi-sub">${fmtUsd(netFlowEth * state.prices.eth)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transactions <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">All chains</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Wallets Analyzed</div>
            <div class="kpi-value">${state.ethData.length + state.btcData.length}</div>
            <div class="kpi-sub">${state.ethData.length} ETH ¬∑ ${state.btcData.length} BTC</div>
        </div>
    `;
    
    renderAllocationChart(ethUsd, btcUsd, stableUsd, otherTokensUsd);
    renderCombinedFlowChart();
}

function renderEthDashboard() {
    const hasData = state.ethData.length > 0;
    document.getElementById('eth-empty').style.display = hasData ? 'none' : '';
    document.getElementById('eth-content').style.display = hasData ? '' : 'none';
    if (!hasData) return;
    
    const totalEth = state.ethData.reduce((s, w) => s + w.balance, 0);
    const ethUsd = totalEth * state.prices.eth;
    
    let totalTokenValue = 0;
    let stableValue = 0;
    const allTokens = new Map();
    
    state.ethData.forEach(w => {
        w.tokens.forEach(t => {
            totalTokenValue += t.valueUsd || 0;
            if (CONFIG.STABLECOINS.includes(t.symbol.toLowerCase())) {
                stableValue += t.valueUsd || t.balance;
            }
            
            const existing = allTokens.get(t.symbol) || { ...t, balance: 0, valueUsd: 0 };
            existing.balance += t.balance;
            existing.valueUsd += t.valueUsd || 0;
            allTokens.set(t.symbol, existing);
        });
    });
    
    const netFlow = state.ethData.reduce((s, w) => s + (w.inflow - w.outflow), 0);
    const totalTx = state.ethData.reduce((s, w) => s + w.txCount, 0);
    const totalGas = state.ethData.reduce((s, w) => s + w.gasSpent, 0);
    
    document.getElementById('ethKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total ETH</div>
            <div class="kpi-value eth">${fmtEth(totalEth)}</div>
            <div class="kpi-sub">${fmtUsd(ethUsd)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Token Holdings</div>
            <div class="kpi-value gold">${fmtUsd(totalTokenValue)}</div>
            <div class="kpi-sub">${allTokens.size} unique tokens</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Stablecoins</div>
            <div class="kpi-value stable">${fmtUsd(stableValue)}</div>
            <div class="kpi-sub">${ethUsd + totalTokenValue > 0 ? ((stableValue / (ethUsd + totalTokenValue)) * 100).toFixed(1) : 0}%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net Flow <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value ${netFlow >= 0 ? 'success' : 'danger'}">${netFlow >= 0 ? '+' : ''}${fmtEth(netFlow)}</div>
            <div class="kpi-sub">${fmtUsd(netFlow * state.prices.eth)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transactions <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">Normal txs</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Gas Spent <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value">${fmtEth(totalGas)}</div>
            <div class="kpi-sub">${fmtUsd(totalGas * state.prices.eth)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Inflow <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value success">+${fmtEth(state.ethData.reduce((s, w) => s + w.inflow, 0))}</div>
            <div class="kpi-sub">Received</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Outflow <span class="kpi-badge">${state.period}D</span></div>
            <div class="kpi-value danger">-${fmtEth(state.ethData.reduce((s, w) => s + w.outflow, 0))}</div>
            <div class="kpi-sub">Sent</div>
        </div>
    `;
    
    renderAumChart();
    renderBalanceDistChart();
    renderNetFlowChart();
    renderTopTokensChart([...allTokens.values()]);
    renderTokenListTable([...allTokens.values()]);
    renderSegmentChart();
    renderHeatmap();
    renderLorenzChart();
    renderEthTables();
}

function renderBtcDashboard() {
    const hasData = state.btcData.length > 0;
    document.getElementById('btc-empty').style.display = hasData ? 'none' : '';
    document.getElementById('btc-content').style.display = hasData ? '' : 'none';
    if (!hasData) return;
    
    const totalBtc = state.btcData.reduce((s, w) => s + w.balance, 0);
    const totalReceived = state.btcData.reduce((s, w) => s + w.totalReceived, 0);
    const totalSent = state.btcData.reduce((s, w) => s + w.totalSent, 0);
    const totalTx = state.btcData.reduce((s, w) => s + w.txCount, 0);
    
    document.getElementById('btcKpis').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total BTC</div>
            <div class="kpi-value btc">${fmtBtc(totalBtc)}</div>
            <div class="kpi-sub">${fmtUsd(totalBtc * state.prices.btc)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Received</div>
            <div class="kpi-value success">${fmtBtc(totalReceived)}</div>
            <div class="kpi-sub">${fmtUsd(totalReceived * state.prices.btc)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Sent</div>
            <div class="kpi-value danger">${fmtBtc(totalSent)}</div>
            <div class="kpi-sub">${fmtUsd(totalSent * state.prices.btc)}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Transaction Count</div>
            <div class="kpi-value">${fmt(totalTx, 0)}</div>
            <div class="kpi-sub">All time</div>
        </div>
    `;
    
    renderBtcDistChart();
    renderBtcFlowChart();
    renderBtcTable();
}

// ============================================
// CHART RENDERING
// ============================================
const chartColors = {
    gold: '#B8A45A',
    goldDim: 'rgba(184, 164, 90, 0.3)',
    eth: '#627EEA',
    ethDim: 'rgba(98, 126, 234, 0.3)',
    btc: '#F7931A',
    btcDim: 'rgba(247, 147, 26, 0.3)',
    success: '#34D399',
    successDim: 'rgba(52, 211, 153, 0.5)',
    danger: '#F87171',
    dangerDim: 'rgba(248, 113, 113, 0.5)',
    stable: '#26A17B',
    stableDim: 'rgba(38, 161, 123, 0.3)',
    muted: '#6B7280'
};

const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
        x: { ticks: { color: '#A9ADB5', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#A9ADB5', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
    }
};

function destroyChart(name) {
    if (state.charts[name]) {
        state.charts[name].destroy();
        state.charts[name] = null;
    }
}

function renderAllocationChart(ethUsd, btcUsd, stableUsd, otherUsd) {
    const ctx = document.getElementById('allocationChart');
    if (!ctx) return;
    destroyChart('allocation');
    
    const data = [
        { label: 'ETH', value: ethUsd, color: chartColors.eth },
        { label: 'BTC', value: btcUsd, color: chartColors.btc },
        { label: 'Stables', value: stableUsd, color: chartColors.stable },
        { label: 'Other', value: otherUsd, color: chartColors.gold }
    ].filter(d => d.value > 0);
    
    state.charts.allocation = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.label),
            datasets: [{
                data: data.map(d => d.value),
                backgroundColor: data.map(d => d.color),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { color: '#A9ADB5', font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtUsd(ctx.raw)}` } }
            }
        }
    });
}

function renderCombinedFlowChart() {
    const ctx = document.getElementById('combinedFlowChart');
    if (!ctx) return;
    destroyChart('combinedFlow');
    
    const inflow = state.ethData.reduce((s, w) => s + w.inflow, 0);
    const outflow = state.ethData.reduce((s, w) => s + w.outflow, 0);
    
    state.charts.combinedFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Inflow', 'Outflow'],
            datasets: [{
                data: [inflow, outflow],
                backgroundColor: [chartColors.successDim, chartColors.dangerDim],
                borderColor: [chartColors.success, chartColors.danger],
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => fmtEth(ctx.raw) } }
            }
        }
    });
}

function renderAumChart() {
    const ctx = document.getElementById('aumChart');
    if (!ctx) return;
    destroyChart('aum');
    
    const ethValue = state.ethData.reduce((s, w) => s + w.balance, 0) * state.prices.eth;
    const tokenValue = state.ethData.reduce((s, w) => s + w.tokens.reduce((ts, t) => ts + (t.valueUsd || 0), 0), 0);
    
    state.charts.aum = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ETH', 'Tokens'],
            datasets: [{
                data: [ethValue, tokenValue],
                backgroundColor: [chartColors.eth, chartColors.gold],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { color: '#A9ADB5', font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtUsd(ctx.raw)}` } }
            }
        }
    });
}

function renderBalanceDistChart() {
    const ctx = document.getElementById('balanceDistChart');
    if (!ctx) return;
    destroyChart('balanceDist');
    
    const sorted = [...state.ethData].sort((a, b) => b.balance - a.balance);
    
    state.charts.balanceDist = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(w => w.label || shorten(w.address)),
            datasets: [{
                data: sorted.map(w => w.balance),
                backgroundColor: chartColors.ethDim,
                borderColor: chartColors.eth,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => fmtEth(ctx.raw) } }
            }
        }
    });
}

function renderNetFlowChart() {
    const ctx = document.getElementById('netFlowChart');
    if (!ctx) return;
    destroyChart('netFlow');
    
    const data = state.ethData.map(w => ({
        label: w.label || shorten(w.address),
        inflow: w.inflow,
        outflow: w.outflow
    }));
    
    state.charts.netFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.label),
            datasets: [
                {
                    label: 'Inflow',
                    data: data.map(d => d.inflow),
                    backgroundColor: chartColors.successDim,
                    borderColor: chartColors.success,
                    borderWidth: 1
                },
                {
                    label: 'Outflow',
                    data: data.map(d => -d.outflow),
                    backgroundColor: chartColors.dangerDim,
                    borderColor: chartColors.danger,
                    borderWidth: 1
                }
            ]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: { display: true, labels: { color: '#A9ADB5', font: { size: 10 } } },
                tooltip: { callbacks: { label: ctx => fmtEth(Math.abs(ctx.raw)) } }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#A9ADB5' }, grid: { display: false } },
                y: { stacked: true, ticks: { color: '#A9ADB5' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}

function renderTopTokensChart(tokens) {
    const ctx = document.getElementById('topTokensChart');
    if (!ctx) return;
    destroyChart('topTokens');
    
    const top10 = tokens.sort((a, b) => b.valueUsd - a.valueUsd).slice(0, 10);
    
    state.charts.topTokens = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(t => t.symbol),
            datasets: [{
                data: top10.map(t => t.valueUsd),
                backgroundColor: chartColors.goldDim,
                borderColor: chartColors.gold,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: { 
                    callbacks: { 
                        label: ctx => {
                            const token = top10[ctx.dataIndex];
                            return `${fmtUsd(token.valueUsd)} (${fmt(token.balance, 4)} ${token.symbol})`;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { callback: v => fmtUsd(v), color: '#A9ADB5' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: '#A9ADB5' }, grid: { display: false } }
            }
        }
    });
}

function renderTokenListTable(tokens) {
    const tbody = document.querySelector('#allTokensTable tbody');
    if (!tbody) return;
    
    const sorted = tokens.sort((a, b) => b.valueUsd - a.valueUsd);
    const totalValue = sorted.reduce((s, t) => s + t.valueUsd, 0);
    
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">No tokens found</td></tr>';
        return;
    }
    
    tbody.innerHTML = sorted.map((t, i) => `
        <tr>
            <td>${i + 1}</td>
            <td><div style="font-weight:500">${t.symbol}</div><div style="font-size:10px;color:var(--text-muted)">${t.name}</div></td>
            <td style="text-align:right;font-family:monospace">${fmt(t.balance, t.balance < 1 ? 6 : 2)}</td>
            <td style="text-align:right;color:var(--text-muted)">${t.price > 0 ? fmtUsd(t.price) : '‚Äî'}</td>
            <td style="text-align:right;font-weight:500;color:${t.valueUsd > 0 ? 'var(--gold)' : 'var(--text-muted)'}">${t.valueUsd > 0 ? fmtUsd(t.valueUsd) : '‚Äî'}</td>
            <td style="text-align:right;color:var(--text-muted)">${totalValue > 0 ? ((t.valueUsd / totalValue) * 100).toFixed(1) + '%' : '‚Äî'}</td>
        </tr>
    `).join('');
}

function renderSegmentChart() {
    const ctx = document.getElementById('segmentChart');
    if (!ctx) return;
    destroyChart('segment');
    
    const segments = { Active: 0, Hodler: 0, Inactive: 0 };
    state.ethData.forEach(w => {
        if (w.txCount > 10) segments.Active++;
        else if (w.balance > 0) segments.Hodler++;
        else segments.Inactive++;
    });
    
    const data = Object.entries(segments).filter(([_, v]) => v > 0);
    const colors = ['#34D399', '#B8A45A', '#6B7280'];
    
    state.charts.segment = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d[0]),
            datasets: [{
                data: data.map(d => d[1]),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { color: '#A9ADB5', font: { size: 10 } } } }
        }
    });
}

function renderHeatmap() {
    const container = document.getElementById('heatmapGrid');
    if (!container) return;
    
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const heat = Array(7).fill(null).map(() => Array(24).fill(0));
    
    // Aggregate transactions by day/hour
    state.ethData.forEach(w => {
        (w.transactions || []).forEach(tx => {
            const date = new Date(tx.timestamp * 1000);
            const day = date.getUTCDay();
            const hour = date.getUTCHours();
            heat[day][hour]++;
        });
    });
    
    const maxVal = Math.max(...heat.flat(), 1);
    
    let html = '<div class="heatmap-row heatmap-header"><div class="heatmap-label"></div>';
    for (let h = 0; h < 24; h += 3) {
        html += `<div class="heatmap-hour">${h}h</div>`;
    }
    html += '</div>';
    
    days.forEach((day, d) => {
        html += `<div class="heatmap-row"><div class="heatmap-label">${day}</div>`;
        for (let h = 0; h < 24; h++) {
            const intensity = heat[d][h] / maxVal;
            const alpha = Math.min(intensity * 0.8 + 0.1, 1);
            const bg = heat[d][h] > 0 ? `rgba(184, 164, 90, ${alpha})` : 'rgba(255,255,255,0.03)';
            html += `<div class="heatmap-cell" style="background:${bg}" title="${day} ${h}:00 - ${heat[d][h]} tx"></div>`;
        }
        html += '</div>';
    });
    
    container.innerHTML = html;
}

function renderLorenzChart() {
    const ctx = document.getElementById('lorenzChart');
    if (!ctx) return;
    destroyChart('lorenz');
    
    const balances = state.ethData.map(w => w.balance * state.prices.eth).sort((a, b) => a - b);
    if (balances.length === 0) return;
    
    const total = balances.reduce((s, v) => s + v, 0);
    const n = balances.length;
    
    // Calculate Lorenz curve points
    const lorenz = [{ x: 0, y: 0 }];
    let cumSum = 0;
    balances.forEach((v, i) => {
        cumSum += v;
        lorenz.push({ x: (i + 1) / n * 100, y: cumSum / total * 100 });
    });
    
    // Calculate Gini coefficient
    let giniSum = 0;
    for (let i = 0; i < n; i++) {
        giniSum += (2 * (i + 1) - n - 1) * balances[i];
    }
    const gini = giniSum / (n * total);
    document.getElementById('giniValue').textContent = gini.toFixed(3);
    
    state.charts.lorenz = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Perfect Equality',
                    data: [{ x: 0, y: 0 }, { x: 100, y: 100 }],
                    borderColor: chartColors.muted,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Lorenz Curve',
                    data: lorenz,
                    borderColor: chartColors.gold,
                    backgroundColor: chartColors.goldDim,
                    pointRadius: 0,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { type: 'linear', min: 0, max: 100, ticks: { callback: v => v + '%', color: '#A9ADB5' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { min: 0, max: 100, ticks: { callback: v => v + '%', color: '#A9ADB5' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}

function renderEthTables() {
    // Top wallets table
    const tbody = document.querySelector('#topWalletsTable tbody');
    if (tbody) {
        const sorted = [...state.ethData]
            .map(w => ({ ...w, totalValue: w.balanceUsd + w.tokens.reduce((s, t) => s + (t.valueUsd || 0), 0) }))
            .sort((a, b) => b.totalValue - a.totalValue)
            .slice(0, 10);
        
        const totalAum = sorted.reduce((s, w) => s + w.totalValue, 0);
        
        tbody.innerHTML = sorted.map((w, i) => `
            <tr>
                <td>${i + 1}</td>
                <td><div style="font-weight:500">${w.label || shorten(w.address)}</div></td>
                <td style="font-weight:500;color:var(--gold)">${fmtUsd(w.totalValue)}</td>
                <td>${totalAum > 0 ? ((w.totalValue / totalAum) * 100).toFixed(1) + '%' : '‚Äî'}</td>
                <td><span style="color:${w.txCount > 0 ? 'var(--success)' : 'var(--text-muted)'}">${w.txCount > 0 ? 'Active' : 'Inactive'}</span></td>
            </tr>
        `).join('');
    }
    
    // All wallets table
    const allTbody = document.querySelector('#allEthWalletsTable tbody');
    if (allTbody) {
        const sorted = [...state.ethData]
            .map(w => ({ ...w, totalValue: w.balanceUsd + w.tokens.reduce((s, t) => s + (t.valueUsd || 0), 0) }))
            .sort((a, b) => b.totalValue - a.totalValue);
        
        allTbody.innerHTML = sorted.map((w, i) => `
            <tr>
                <td>${i + 1}</td>
                <td><a href="https://etherscan.io/address/${w.address}" target="_blank" style="color:var(--text)">${w.label || shorten(w.address)}</a></td>
                <td style="color:var(--gold)">${fmtUsd(w.totalValue)}</td>
                <td>${w.tokens.length}</td>
                <td>${w.txCount}</td>
                <td>‚Äî</td>
                <td>‚Äî</td>
                <td>‚Äî</td>
                <td><span style="color:${w.txCount > 0 ? 'var(--success)' : 'var(--text-muted)'}">${w.txCount > 0 ? 'Active' : 'Hodler'}</span></td>
            </tr>
        `).join('');
    }
}

function renderBtcDistChart() {
    const ctx = document.getElementById('btcDistChart');
    if (!ctx) return;
    destroyChart('btcDist');
    
    const sorted = [...state.btcData].sort((a, b) => b.balance - a.balance);
    
    state.charts.btcDist = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(w => w.label || shorten(w.address)),
            datasets: [{
                data: sorted.map(w => w.balance),
                backgroundColor: chartColors.btcDim,
                borderColor: chartColors.btc,
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => fmtBtc(ctx.raw) } }
            }
        }
    });
}

function renderBtcFlowChart() {
    const ctx = document.getElementById('btcFlowChart');
    if (!ctx) return;
    destroyChart('btcFlow');
    
    const received = state.btcData.reduce((s, w) => s + w.totalReceived, 0);
    const sent = state.btcData.reduce((s, w) => s + w.totalSent, 0);
    
    state.charts.btcFlow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Received', 'Sent'],
            datasets: [{
                data: [received, sent],
                backgroundColor: [chartColors.successDim, chartColors.dangerDim],
                borderColor: [chartColors.success, chartColors.danger],
                borderWidth: 1
            }]
        },
        options: {
            ...chartDefaults,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => fmtBtc(ctx.raw) } }
            }
        }
    });
}

function renderBtcTable() {
    const tbody = document.querySelector('#allBtcTable tbody');
    if (!tbody) return;
    
    const sorted = [...state.btcData].sort((a, b) => b.balance - a.balance);
    
    tbody.innerHTML = sorted.map((w, i) => `
        <tr>
            <td>${i + 1}</td>
            <td><a href="https://mempool.space/address/${w.address}" target="_blank" style="color:var(--text)">${w.label || shorten(w.address)}</a></td>
            <td style="color:var(--btc-color)">${fmtBtc(w.balance)}</td>
            <td style="color:var(--gold)">${fmtUsd(w.balanceUsd)}</td>
            <td>${w.txCount}</td>
            <td style="color:var(--success)">${fmtBtc(w.totalReceived)}</td>
            <td style="color:var(--danger)">${fmtBtc(w.totalSent)}</td>
        </tr>
    `).join('');
}

function sortEthTable(col) {
    // Simple sort toggle - can be expanded
    state.ethTableSort = { col, asc: state.ethTableSort?.col === col ? !state.ethTableSort.asc : false };
    renderEthTables();
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
    loadState();
    
    // Set default period to 180 days (6 months)
    const labels = { 7: '7D', 30: '30D', 90: '90D', 180: '6M', 365: '1Y', 0: 'All' };
    document.getElementById('periodValue').textContent = labels[state.period] || '6M';
    document.querySelectorAll('.dropdown-item[data-period]').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.period) === state.period);
    });
    
    // Initialize UI
    renderWalletList();
    updateCounts();
    updateMobileWalletCount();
    setSegment(state.segment);
    
    // Initialize settings chips
    Object.entries(state.visibleStats).forEach(([stat, visible]) => {
        document.querySelectorAll(`.setting-chip[data-stat="${stat}"]`).forEach(el => {
            el.classList.toggle('active', visible);
        });
    });
    
    // Close dropdown on outside click
    document.addEventListener('click', e => {
        if (!e.target.closest('#periodDropdown')) closePeriodDropdown();
    });
    
    // Fetch initial prices
    await fetchPrices();
    
    document.getElementById('apiStatus').textContent = state.prices.eth > 0 ? 'Ready' : 'Error';
    document.getElementById('apiStatus').className = 'status-value ' + (state.prices.eth > 0 ? 'success' : 'warning');
});
</script>
</body>
</html>
